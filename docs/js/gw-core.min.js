!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{})}(this,(function(t){"use strict";const e=[[0,1],[1,0],[0,-1],[-1,0],[1,1],[1,-1],[-1,-1],[-1,1]],n=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];function r(){return!0}function i(t){return t}function o(t,e,n){return t<e?e:t>n?n:t}function s(t){return t.x||t[0]||0}function h(t){return t.y||t[1]||0}function u(t,e,n,r){const i=Math.abs(t-n),o=Math.abs(e-r);return i+o-.6*Math.min(i,o)}function f(t,e,n,r){let i=n-t,o=r-e;if(i&&o){const t=Math.abs(i),e=Math.abs(o);t>=2*e?o=0:e>=2*t&&(i=0)}return[Math.sign(i),Math.sign(o)]}function a(t,e,n=null){let r;Object.keys(e).forEach((i=>{const o=i;let s=e[i];r=t;const h=i.split(".");for(;h.length>1;)i=h.shift(),void 0===r[i]?r=r[i]={}:"object"!=typeof r[i]?c("Trying to set default member on non-object config item: "+o):r=r[i];i=h.shift();let u=r[i];n&&n(r,i,u,s)||void 0===u&&(null===s?r[i]=null:Array.isArray(s)?r[i]=s.slice():r[i]=s)}))}function c(t){throw new Error(t)}function l(...t){console.warn(...t)}var d={__proto__:null,DIRS:e,NO_DIRECTION:-1,UP:0,RIGHT:1,DOWN:2,LEFT:3,RIGHT_UP:4,RIGHT_DOWN:5,LEFT_DOWN:6,LEFT_UP:7,CLOCK_DIRS:n,NOOP:function(){},TRUE:r,FALSE:function(){return!1},ONE:function(){return 1},ZERO:function(){return 0},IDENTITY:i,clamp:o,x:s,y:h,copyXY:function(t,e){t.x=s(e),t.y=h(e)},addXY:function(t,e){t.x+=s(e),t.y+=h(e)},equalsXY:function(t,e){return t.x==s(e)&&t.y==h(e)},lerpXY:function(t,e,n){n>1&&(n/=100),n=o(n,0,1);const r=s(e)-s(t),i=h(e)-h(t);return[s(t)+Math.floor(r*n),h(t)+Math.floor(i*n)]},distanceBetween:u,distanceFromTo:function(t,e){return u(s(t),h(t),s(e),h(e))},calcRadius:function(t,e){return u(0,0,t,e)},dirBetween:f,dirFromTo:function(t,e){return f(s(t),h(t),s(e),h(e))},dirIndex:function(t){const n=s(t),r=h(t);return e.findIndex((t=>t[0]==n&&t[1]==r))},isOppositeDir:function(t,e){return t[0]+e[0]==0&&t[1]+e[1]==0},isSameDir:function(t,e){return t[0]==e[0]&&t[1]==e[1]},dirSpread:function(t){const e=[t];return 0==t[0]?(e.push([1,t[1]]),e.push([-1,t[1]])):0==t[1]?(e.push([t[0],1]),e.push([t[0],-1])):(e.push([t[0],0]),e.push([0,t[1]])),e},stepFromTo:function(t,e,n){const r=s(t),i=h(t),o=[s(e)-r,h(e)-i],u=Math.abs(o[0])+Math.abs(o[1]),f=[0,0],a=[99999,99999];for(let t=0;t<=u;++t)f[0]=r+Math.floor(o[0]*t/u),f[1]=i+Math.floor(o[1]*t/u),f[0]==a[0]&&f[1]==a[1]||n(f[0],f[1]),a[0]=f[0],a[1]=f[1]},smoothHiliteGradient:function(t,e){return Math.floor(100*Math.sin(Math.PI*t/e))},assignOmitting:function(t,e,n){"string"==typeof t&&(t=t.split(/[,|]/g).map((t=>t.trim()))),Object.keys(n).forEach((r=>{t.includes(r)||function(t,e,n){const r=t[n],i=e[n];r&&r.copy&&i?r.copy(i):r&&r.clear&&!i?r.clear():r&&r.nullify&&!i?r.nullify():i&&i.clone?t[n]=i.clone():i&&Array.isArray(i)?t[n]=i.slice():r&&Array.isArray(r)?r.length=0:t[n]=i}(e,n,r)}))},setDefault:function(t,e,n){void 0===t[e]&&(t[e]=n)},setDefaults:a,kindDefaults:function(t,e){return a(t,e,(function(t,e,n,r){return!(e.search(/[fF]lags$/)<0)&&(n?"string"==typeof n?n=n.split(/[,|]/).map((t=>t.trim())):Array.isArray(n)||(n=[n]):n=[],"string"==typeof r?r=r.split(/[,|]/).map((t=>t.trim())):Array.isArray(r)||(r=[r]),t[e]=r.concat(n),!0)}))},pick:function(t,...e){const n={};return e.forEach((e=>{const r=t[e];void 0!==r&&(n[e]=r)})),n},clearObject:function(t){Object.keys(t).forEach((e=>t[e]=void 0))},ERROR:c,WARN:l,getOpt:function(t,e,n){const r=t[e];return void 0===r?n:r},firstOpt:function(t,...e){for(let n of e){if("object"!=typeof n||Array.isArray(n))return n;if(void 0!==n[t])return n[t]}},arraysIntersect:function(t,e){return t.some((t=>e.includes(t)))},sum:function(t){return t.reduce(((t,e)=>t+e))},chainLength:function(t){let e=0;for(;t;)e+=1,t=t.next;return e},chainIncludes:function(t,e){for(;t&&t!==e;)t=t.next;return t===e},eachChain:function(t,e){let n=0;for(;t;){const r=t.next;e(t,n++),t=r}return n},addToChain:function(t,e,n){return n.next=t[e]||null,t[e]=n,!0},removeFromChain:function(t,e,n){const r=t[e];if(r===n)return t[e]=n.next||null,n.next=null,!0;if(!r)return!1;{let t=r,e=t.next;for(;e&&e!==n;)t=e,e=t.next;if(e===n)return t.next=e.next||null,n.next=null,!0}return!1}};const p={make:()=>Math.random.bind(Math)};function y(t,e){let n,r,i;for(r=0,n=0;n<e.length;n++)r+=e[n];if(r<=0)return console.warn("Lottery Draw - no frequencies",e,e.length),0;for(i=t.range(0,r-1),n=0;n<e.length;n++){if(e[n]>i)return n;i-=e[n]}return console.warn("Lottery Draw failed.",e,e.length),0}class m{constructor(){this._fn=p.make()}static configure(t){if(t.make){if("function"!=typeof t.make)throw new Error("Random make parameter must be a function.");if("function"!=typeof t.make(12345))throw new Error("Random make function must accept a numeric seed and return a random function.");p.make=t.make,g.seed(),w.seed()}}seed(t){this._fn=p.make(t)}value(){return this._fn()}float(){return this.value()}number(t=0){return t=t||Number.MAX_SAFE_INTEGER,Math.floor(this._fn()*t)}int(t=0){return this.number(t)}range(t,e){if(e<=t)return e;const n=e-t+1;return t+this.number(n)}dice(t,e,n=0){let r=0,i=1;t<0&&(t=-t,i=-1),n=n||0;for(let n=0;n<t;++n)r+=this.range(1,e);return r*=i,r+n}weighted(t){return Array.isArray(t)?y(this,t):function(t,e){const n=Object.entries(e),r=n.map((([t,e])=>e));return n[y(t,r)][0]}(this,t)}item(t){return Array.isArray(t)||(t=Object.values(t)),t[this.range(0,t.length-1)]}key(t){return this.item(Object.keys(t))}shuffle(t,e=0,n=0){let r,i,o;for(2==arguments.length&&(n=e,e=0),n=n||t.length,r=e=e||0;r<n;r++)i=this.range(e,n-1),r!=i&&(o=t[i],t[i]=t[r],t[r]=o);return t}sequence(t){const e=[];for(let n=0;n<t;n++)e[n]=n;return this.shuffle(e)}chance(t,e=100){return!(t<=0)&&(t>=e||this.number(e)<t)}clumped(t,e,n){if(e<=t)return t;if(n<=1)return this.range(t,e);let r,i=0,o=Math.floor((e-t)/n);for(r=0;r<(e-t)%n;r++)i+=this.range(0,o+1);for(;r<n;r++)i+=this.range(0,o);return i+t}}const g=new m,w=new m;class E{constructor(t,e=0,n=1,r){this._rng=r||g,Array.isArray(t)?(n=t[2],e=t[1],t=t[0]):t instanceof E&&(n=t.clumps,e=t.hi,t=t.lo),e<t&&([e,t]=[t,e]),this.lo=t||0,this.hi=e||this.lo,this.clumps=n||1}value(){return this._rng.clumped(this.lo,this.hi,this.clumps)}toString(){return this.lo>=this.hi?""+this.lo:`${this.lo}-${this.hi}`}}var v={__proto__:null,Range:E,make:function(t,e){if(!t)return new E(0,0,0,e);if(t instanceof E)return t;if("function"==typeof t)throw new Error("Custom range functions not supported - extend Range");if(null==t)return new E(0,0,0,e);if("number"==typeof t)return new E(t,t,1,e);if(!0===t||!1===t)throw new Error("Invalid random config: "+t);if(Array.isArray(t))return new E(t[0],t[1],t[2],e);if("string"!=typeof t)throw new Error("Calculations must be strings.  Received: "+JSON.stringify(t));if(0==t.length)return new E(0,0,0,e);const n=/^(?:([+-]?\d*)[Dd](\d+)([+-]?\d*)|([+-]?\d+)-(\d+):?(\d+)?|([+-]?\d+)~(\d+)|([+-]?\d+\.?\d*))/g;let r;for(;null!==(r=n.exec(t));){if(r[2]){let t=Number.parseInt(r[1])||1;const n=Number.parseInt(r[2]),i=Number.parseInt(r[3])||0;return new E(i+t,i+t*n,t,e)}if(r[4]&&r[5]){const t=Number.parseInt(r[4]),n=Number.parseInt(r[5]),i=Number.parseInt(r[6]);return new E(t,n,i,e)}if(r[7]&&r[8]){const t=Number.parseInt(r[7]),n=Number.parseInt(r[8]);return new E(t-2*n,t+2*n,3,e)}if(r[9]){const t=Number.parseFloat(r[9]);return new E(t,t,1,e)}}throw new Error("Not a valid range - "+t)}};const x={};var M={__proto__:null,fl:function(t){return 1<<t},toString:function(t,e){const n=Object.entries(t).reduce(((t,e)=>{const[n,r]=e;return r&&(t[r]=n),t}),[]),r=[];for(let t=0;t<32;++t){const i=1<<t;e&i&&r.push(n[i])}return r.join(" | ")},from:function(t,...e){let n=0;for(let r=0;r<e.length;++r){let i=e[r];void 0!==i&&("number"!=typeof i?("string"==typeof i&&(i=i.split(/[,|]/).map((t=>t.trim())).map((t=>{const e=Number.parseInt(t);return e>=0?e:t}))),Array.isArray(i)&&i.forEach((e=>{if("string"==typeof e)if((e=e.trim()).startsWith("!")){const r=t[e.substring(1)];n&=~r}else{const r=t[e];r&&(n|=r)}else 0===e?n=0:n|=e}))):n|=i)}return n},flags:x,install:function(t,e){return x[t]=e,e}};const b=e,A=n;function R(t){return!1===t?" ":!0===t?"T":t<10?""+t:t<36?String.fromCharCode("a".charCodeAt(0)+t-10):t<62?String.fromCharCode("A".charCodeAt(0)+t-10-26):"string"==typeof t?t[0]:"#"}class _ extends Array{constructor(t,e,n){super(t);for(let r=0;r<t;++r)this[r]="function"==typeof n?new Array(e).fill(0).map(((t,e)=>n(r,e))):new Array(e).fill(n);this._width=t,this._height=e}get width(){return this._width}get height(){return this._height}forEach(t){let e,n;for(e=0;e<this.width;e++)for(n=0;n<this.height;n++)t(this[e][n],e,n,this)}eachNeighbor(t,e,n,r=!1){const i=r?4:8;for(let r=0;r<i;++r){const i=b[r],o=t+i[0],s=e+i[1];this.hasXY(o,s)&&n(this[o][s],o,s,this)}}forRect(t,e,n,r,i){n=Math.min(this.width-t,n),r=Math.min(this.height-e,r);for(let o=t;o<t+n;++o)for(let t=e;t<e+r;++t)i(this[o][t],o,t,this)}map(t){return super.map(((e,n)=>e.map(((e,r)=>t(e,n,r,this)))))}forCircle(t,e,n,r){let i,o;for(i=Math.max(0,t-n-1);i<Math.min(this.width,t+n+1);i++)for(o=Math.max(0,e-n-1);o<Math.min(this.height,e+n+1);o++)this.hasXY(i,o)&&(i-t)*(i-t)+(o-e)*(o-e)<n*n+n&&r(this[i][o],i,o,this)}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}isBoundaryXY(t,e){return this.hasXY(t,e)&&(0==t||t==this.width-1||0==e||e==this.height-1)}calcBounds(){const t={left:this.width,top:this.height,right:0,bottom:0};return this.forEach(((e,n,r)=>{e&&(t.left>n&&(t.left=n),t.right<n&&(t.right=n),t.top>r&&(t.top=r),t.bottom<r&&(t.bottom=r))})),t}update(t){let e,n;for(e=0;e<this.width;e++)for(n=0;n<this.height;n++)this[e][n]=t(this[e][n],e,n,this)}updateRect(t,e,n,r,i){let o,s;for(o=t;o<t+n;o++)for(s=e;s<e+r;s++)this.hasXY(o,s)&&(this[o][s]=i(this[o][s],o,s,this))}updateCircle(t,e,n,r){let i,o;for(i=Math.max(0,t-n-1);i<Math.min(this.width,t+n+1);i++)for(o=Math.max(0,e-n-1);o<Math.min(this.height,e+n+1);o++)this.hasXY(i,o)&&(i-t)*(i-t)+(o-e)*(o-e)<n*n+n&&(this[i][o]=r(this[i][o],i,o,this))}fill(t){const e="function"==typeof t?t:()=>t;this.update(e)}fillRect(t,e,n,r,i){const o="function"==typeof i?i:()=>i;this.updateRect(t,e,n,r,o)}fillCircle(t,e,n,r){const i="function"==typeof r?r:()=>r;this.updateCircle(t,e,n,i)}replace(t,e){this.update((n=>n==t?e:n))}copy(t){this.update(((e,n,r)=>t[n][r]))}count(t){const e="function"==typeof t?t:e=>e==t;let n=0;return this.forEach(((t,r,i)=>{e(t,r,i,this)&&++n})),n}dump(t){this.dumpRect(0,0,this.width,this.height,t)}dumpRect(t,e,n,r,i){let s,h;i=i||R,t=o(t,0,this.width-2),e=o(e,0,this.height-2);const u=o(t+n,1,this.width-1),f=o(e+r,1,this.height-1);let a=[];for(h=e;h<=f;h++){let e=(h+"]").padStart(3," ");for(s=t;s<=u;s++){s%10==0&&(e+=" ");e+=i(this[s][h],s,h)[0]}a.push(e)}console.log(a.join("\n"))}dumpAround(t,e,n){this.dumpRect(t-n,e-n,2*n,2*n)}closestMatchingLoc(t,e,n){let r=[-1,-1],i=this.width+this.height;return this.forEach(((o,s,h)=>{if(n(o,s,h,this)){const n=u(t,e,s,h);n<i?(r[0]=s,r[1]=h,i=n):n==i&&g.chance(50)&&(r[0]=s,r[1]=h)}})),r}firstMatchingLoc(t){const e="function"==typeof t?t:e=>e==t;for(let t=0;t<this.width;++t)for(let n=0;n<this.height;++n)if(e(this[t][n],t,n,this))return[t,n];return[-1,-1]}randomMatchingLoc(t,e=!1){let n,r,i,o=0;const s="function"==typeof t?t:e=>e==t;if(o=0,this.forEach(((t,e,n)=>{s(t,e,n,this)&&o++})),0==o)return[-1,-1];for(i=e?Math.floor(o/2):g.range(0,o-1),n=0;n<this.width&&i>=0;n++)for(r=0;r<this.height&&i>=0;r++)if(s(this[n][r],n,r,this)){if(0==i)return[n,r];i--}return[-1,-1]}matchingLocNear(t,e,n,r=!1){let i,o,s,h,u,f=[-1,-1];const a="function"==typeof n?n:t=>t==n;for(h=0,s=0;s<Math.max(this.width,this.height)&&!h;s++)for(i=t-s;i<=t+s;i++)for(o=e-s;o<=e+s;o++)this.hasXY(i,o)&&(i==t-s||i==t+s||o==e-s||o==e+s)&&a(this[i][o],i,o,this)&&h++;if(0==h)return[-1,-1];for(u=r?1+Math.floor(h/2):1+g.number(h),s=0;s<Math.max(this.width,this.height);s++)for(i=t-s;i<=t+s;i++)for(o=e-s;o<=e+s;o++)if(this.hasXY(i,o)&&(i==t-s||i==t+s||o==e-s||o==e+s)&&a(this[i][o],i,o,this)&&0==--u)return f[0]=i,f[1]=o,f;return[-1,-1]}arcCount(t,e,n){let r,o,s,h,u,f;for(n=n||i,r=0,o=0;o<A.length;o++)s=t+A[(o+7)%8][0],h=e+A[(o+7)%8][1],u=t+A[o][0],f=e+A[o][1],(this.hasXY(u,f)&&n(this[u][f],u,f,this))!=(this.hasXY(s,h)&&n(this[s][h],s,h,this))&&r++;return Math.floor(r/2)}}const k=[];class N extends _{constructor(t,e,n=0){super(t,e,n)}static alloc(t,e,n=0){if(!t||!e)throw new Error("Grid alloc requires width and height parameters.");let r=k.pop();return r?(r.resize(t,e,n),r):new N(t,e,n)}static free(t){if(t){if(k.indexOf(t)>=0)return;k.push(t)}}resize(t,e,n=0){const r="function"==typeof n?n:()=>n;for(;this.length<t;)this.push([]);this.length=t;let i=0,o=0;for(i=0;i<t;++i){const t=this[i];for(o=0;o<e;++o)t[o]=r(i,o);t.length=e}this._width=t,this._height=e,void 0!==this.x&&(this.x=void 0,this.y=void 0)}findReplaceRange(t,e,n){this.update((r=>r>=t&&r<=e?n:r))}floodFillRange(t,e,n=0,r=0,i=0){let o,s,h,u=1;if(i>=n&&i<=r)throw new Error("Invalid grid flood fill");for(this[t][e]=i,o=0;o<4;o++)s=t+b[o][0],h=e+b[o][1],this.hasXY(s,h)&&this[s][h]>=n&&this[s][h]<=r&&(u+=this.floodFillRange(s,h,n,r,i));return u}invert(){this.update((t=>t?0:1))}closestLocWithValue(t,e,n=1){return this.closestMatchingLoc(t,e,(t=>t==n))}randomLocWithValue(t=1){return this.randomMatchingLoc((e=>e==t))}getQualifyingLocNear(t,e,n=!1){return this.matchingLocNear(t,e,(t=>!!t),n)}leastPositiveValue(){let t=Number.MAX_SAFE_INTEGER;return this.forEach((e=>{e>0&&e<t&&(t=e)})),t}randomLeastPositiveLoc(t=!1){const e=this.leastPositiveValue();return this.randomMatchingLoc((t=>t==e),t)}floodFill(t,e,n,r){let i,o,s,h=1;const u="function"==typeof n?n:t=>t==n,f="function"==typeof r?r:()=>r;for(this[t][e]=f(this[t][e],t,e,this),i=0;i<4;i++)o=t+b[i][0],s=e+b[i][1],this.hasXY(o,s)&&u(this[o][s],o,s,this)&&(h+=this.floodFill(o,s,u,f));return h}_cellularAutomataRound(t,e){let n,r,i,o,s,h,u;u=N.alloc(this.width,this.height),u.copy(this);let f=!1;for(n=0;n<this.width;n++)for(r=0;r<this.height;r++){for(i=0,h=0;h<b.length;h++)o=n+b[h][0],s=r+b[h][1],this.hasXY(o,s)&&u[o][s]&&i++;u[n][r]||"t"!=t[i]?u[n][r]&&"t"==e[i]||(this[n][r]=0,f=!0):(this[n][r]=1,f=!0)}return N.free(u),f}fillBlob(t,e,n,r,i,o,s,h){let u,f,a,c,l,d,p,y,m,w,E,v,x,M;e>=r&&(e=Math.round(.75*r),r=Math.round(1.25*r)),n>=i&&(n=Math.round(.75*i),i=Math.round(1.25*i));const b=Math.floor((this.width-r)/2),A=Math.floor((this.height-i)/2);do{for(this.fill(0),u=0;u<r;u++)for(f=0;f<i;f++)this[u+b][f+A]=g.chance(o)?1:0;for(a=0;a<t;a++)this._cellularAutomataRound(s,h)||(a=t);for(p=0,d=0,y=this.width,w=0,m=this.height,E=0,c=2,u=0;u<this.width;u++)for(f=0;f<this.height;f++)1==this[u][f]&&(l=this.floodFill(u,f,1,c),l>p&&(p=l,d=c),c++);for(u=0;u<this.width;u++){for(M=!1,f=0;f<this.height;f++)if(this[u][f]==d){M=!0;break}M&&(u<y&&(y=u),u>w&&(w=u))}for(f=0;f<this.height;f++){for(M=!1,u=0;u<this.width;u++)if(this[u][f]==d){M=!0;break}M&&(f<m&&(m=f),f>E&&(E=f))}v=w-y+1,x=E-m+1}while(v<e||x<n||0==d);for(u=0;u<this.width;u++)for(f=0;f<this.height;f++)this[u][f]==d?this[u][f]=1:this[u][f]=0;return{x:y,y:m,width:v,height:x}}}const K=N.alloc.bind(N),C=N.free.bind(N);var O={__proto__:null,makeArray:function(t,e){if(void 0===e)return new Array(t).fill(0);e=e||(()=>0);const n=new Array(t);for(let r=0;r<t;++r)n[r]=e(r);return n},Grid:_,NumGrid:N,alloc:K,free:C,make:function(t,e,n){return void 0===n?new N(t,e,0):"number"==typeof n?new N(t,e,n):new _(t,e,n)},offsetZip:function(t,e,n,r,i){const o="function"==typeof i?i:(e,n,r,o)=>t[r][o]=i||n;e.forEach(((i,s,h)=>{const u=s+n,f=h+r;t.hasXY(u,f)&&i&&o(t[u][f],i,u,f,s,h,t,e)}))},directionOfDoorSite:function(t,e,n,r){let i,o,s,h,u,f;const a="function"==typeof r?r:t=>t==r;for(o=-1,i=0;i<4;i++)if(s=e+b[i][0],h=n+b[i][1],u=e-b[i][0],f=n-b[i][1],t.hasXY(u,f)&&t.hasXY(s,h)&&a(t[u][f],u,f,t)){if(-1!=o)return-1;o=i}return o},intersection:function(t,e,n){n=n||t,t.update(((t,r,i)=>e[r][i]&&n[r][i]))},unite:function(t,e,n){n=n||t,t.update(((t,r,i)=>n[r][i]||e[r][i]))}},I={};let L={};const T=[],X=[],Y={x:-1,y:-1},S="keypress",D="mousemove",F="click",P="tick",j="mouseup",U=["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight"];var G=null,W=null;async function H(t,e){let n,r;return"function"==typeof(e=e||L)?r=e:t.dir?r=e.dir:t.type===S?r=e[t.key]||e[t.code]||e.keypress:e[t.type]&&(r=e[t.type]),r&&("function"==typeof r?n=await r.call(e,t):I[r]?n=await I[r](t):l("No command found: "+r)),"next"in e&&!1===e.next&&(n=!1),V(t),n}function V(t){X.push(t)}function B(t){const e=t.toLowerCase();return"arrowup"===e?[0,-1]:"arrowdown"===e?[0,1]:"arrowleft"===e?[-1,0]:"arrowright"===e?[1,0]:null}var q={x:-1,y:-1};function $(t,e){e=e||r;let n,i=0;for(;T.length;){const t=T.shift();if(t.type===D&&(q.x=t.x,q.y=t.y),e(t))return Promise.resolve(t);V(t)}return void 0===t&&(t=-1),0==t?Promise.resolve(null):(G?console.warn("OVERWRITE HANDLER - nextEvent"):T.length&&console.warn("SET HANDLER WITH QUEUED EVENTS - nextEvent"),G=r=>{if(r.type===D&&(q.x=r.x,q.y=r.y),r.type===P&&t>0){if(i+=r.dt,i<t)return}else if(!e(r))return;G=null,r.dt=i,n(r)},new Promise((t=>n=t)))}async function z(t,e){return void 0===t&&(t=-1),e=e||r,$(t,(function(t){return(t.type===S||t.type===F)&&e(t)}))}async function Q(t){const e=await z(t);return e&&e.type!==P}var Z={__proto__:null,commands:I,addCommand:function(t,e){I[t]=e},KEYPRESS:S,MOUSEMOVE:D,CLICK:F,TICK:P,MOUSEUP:j,setKeymap:function(t){L=t},hasEvents:function(){return T.length},clearEvents:function(){for(;T.length;){const t=T.shift();X.push(t)}},pushEvent:function(t){if(W&&console.log("PAUSED EVENT",t.type),T.length){const e=T[T.length-1];if(e.type===t.type&&e.type===D)return e.x=t.x,e.y=t.y,void V(t)}if(t.type===F){if(Y.x==t.x&&Y.y==t.y)return void V(t);Y.x=t.x,Y.y=t.y}else if(t.type==j)return Y.x=-1,Y.y=-1,void V(t);if(G)G(t);else if(t.type===P){const e=T[0];if(e&&e.type===P)return e.dt+=t.dt,void V(t);T.unshift(t)}else T.push(t)},dispatchEvent:H,makeTickEvent:function(t){const e=X.pop()||{};return e.shiftKey=!1,e.ctrlKey=!1,e.altKey=!1,e.metaKey=!1,e.type=P,e.key=null,e.code=null,e.x=-1,e.y=-1,e.dir=null,e.dt=t,e},makeKeyEvent:function(t){let e=t.key,n=t.code.toLowerCase();t.shiftKey&&(e=e.toUpperCase(),n=n.toUpperCase()),t.ctrlKey&&(e="^"+e,n="^"+n),t.metaKey&&(e="#"+e,n="#"+n),t.altKey&&(n="/"+n);const r=X.pop()||{};return r.shiftKey=t.shiftKey,r.ctrlKey=t.ctrlKey,r.altKey=t.altKey,r.metaKey=t.metaKey,r.type=S,r.key=e,r.code=n,r.x=-1,r.y=-1,r.clientX=-1,r.clientY=-1,r.dir=B(t.code),r.dt=0,r},keyCodeDirection:B,ignoreKeyEvent:function(t){return U.includes(t.code)},mouse:q,makeMouseEvent:function(t,e,n){const r=X.pop()||{};return r.shiftKey=t.shiftKey,r.ctrlKey=t.ctrlKey,r.altKey=t.altKey,r.metaKey=t.metaKey,r.type=t.type,t.buttons&&"mouseup"!==t.type&&(r.type=F),r.key=null,r.code=null,r.x=e,r.y=n,r.clientX=t.clientX,r.clientY=t.clientY,r.dir=null,r.dt=0,r},pauseEvents:function(){W||(W=G,G=null)},resumeEvents:function(){if(W&&(G&&console.warn("overwrite CURRENT HANDLER!"),G=W,W=null,T.length&&G)){const t=T.shift();G(t)}},nextEvent:$,tickMs:async function(t=1){let e;return setTimeout((()=>e()),t),new Promise((t=>e=t))},nextKeyPress:async function(t,e){return void 0===t&&(t=-1),e=e||r,$(t,(function(t){return t.type===S&&e(t)}))},nextKeyOrClick:z,pause:Q,waitForAck:function(){return Q(3e5)},loop:async function(t){let e=!0;for(;e;){const n=await $();n&&await H(n,t)&&(e=!1)}}};t.Random=m,t.cosmetic=w,t.data={},t.flag=M,t.flags=x,t.grid=O,t.io=Z,t.random=g,t.range=v,t.utils=d,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-core.min.js.map
