!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{})}(this,(function(t){"use strict";const e=[[0,1],[1,0],[0,-1],[-1,0],[1,1],[1,-1],[-1,-1],[-1,1]],n=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];function i(){return!0}function r(t){return t}function o(t,e,n){return t<e?e:t>n?n:t}function s(t){return t.x||t[0]||0}function h(t){return t.y||t[1]||0}function u(t,e,n,i){const r=Math.abs(t-n),o=Math.abs(e-i);return r+o-.6*Math.min(r,o)}function l(t,e){return u(0,0,t,e)}function c(t,e,n,i){let r=n-t,o=i-e;if(r&&o){const t=Math.abs(r),e=Math.abs(o);t>=2*e?o=0:e>=2*t&&(r=0)}return[Math.sign(r),Math.sign(o)]}function f(t,e,n=null){let i;Object.keys(e).forEach((r=>{const o=r;let s=e[r];i=t;const h=r.split(".");for(;h.length>1;)r=h.shift(),void 0===i[r]?i=i[r]={}:"object"!=typeof i[r]?a("Trying to set default member on non-object config item: "+o):i=i[r];r=h.shift();let u=i[r];n&&n(i,r,u,s)||void 0===u&&(null===s?i[r]=null:Array.isArray(s)?i[r]=s.slice():i[r]=s)}))}function a(t){throw new Error(t)}function d(...t){console.warn(...t)}function p(t,e){let n=0;for(;t;){const i=t.next;e(t,n++),t=i}return n}function y(t,e,n){return n.next=t[e]||null,t[e]=n,!0}function g(t,e,n){const i=t[e];if(i===n)return t[e]=n.next||null,n.next=null,!0;if(!i)return!1;{let t=i,e=t.next;for(;e&&e!==n;)t=e,e=t.next;if(e===n)return t.next=e.next||null,n.next=null,!0}return!1}var m={__proto__:null,DIRS:e,NO_DIRECTION:-1,UP:0,RIGHT:1,DOWN:2,LEFT:3,RIGHT_UP:4,RIGHT_DOWN:5,LEFT_DOWN:6,LEFT_UP:7,CLOCK_DIRS:n,NOOP:function(){},TRUE:i,FALSE:function(){return!1},ONE:function(){return 1},ZERO:function(){return 0},IDENTITY:r,clamp:o,x:s,y:h,copyXY:function(t,e){t.x=s(e),t.y=h(e)},addXY:function(t,e){t.x+=s(e),t.y+=h(e)},equalsXY:function(t,e){return t.x==s(e)&&t.y==h(e)},lerpXY:function(t,e,n){n>1&&(n/=100),n=o(n,0,1);const i=s(e)-s(t),r=h(e)-h(t);return[s(t)+Math.floor(i*n),h(t)+Math.floor(r*n)]},distanceBetween:u,distanceFromTo:function(t,e){return u(s(t),h(t),s(e),h(e))},calcRadius:l,dirBetween:c,dirFromTo:function(t,e){return c(s(t),h(t),s(e),h(e))},dirIndex:function(t){const n=s(t),i=h(t);return e.findIndex((t=>t[0]==n&&t[1]==i))},isOppositeDir:function(t,e){return t[0]+e[0]==0&&t[1]+e[1]==0},isSameDir:function(t,e){return t[0]==e[0]&&t[1]==e[1]},dirSpread:function(t){const e=[t];return 0==t[0]?(e.push([1,t[1]]),e.push([-1,t[1]])):0==t[1]?(e.push([t[0],1]),e.push([t[0],-1])):(e.push([t[0],0]),e.push([0,t[1]])),e},stepFromTo:function(t,e,n){const i=s(t),r=h(t),o=[s(e)-i,h(e)-r],u=Math.abs(o[0])+Math.abs(o[1]),l=[0,0],c=[99999,99999];for(let t=0;t<=u;++t)l[0]=i+Math.floor(o[0]*t/u),l[1]=r+Math.floor(o[1]*t/u),l[0]==c[0]&&l[1]==c[1]||n(l[0],l[1]),c[0]=l[0],c[1]=l[1]},smoothHiliteGradient:function(t,e){return Math.floor(100*Math.sin(Math.PI*t/e))},assignOmitting:function(t,e,n){"string"==typeof t&&(t=t.split(/[,|]/g).map((t=>t.trim()))),Object.keys(n).forEach((i=>{t.includes(i)||function(t,e,n){const i=t[n],r=e[n];i&&i.copy&&r?i.copy(r):i&&i.clear&&!r?i.clear():i&&i.nullify&&!r?i.nullify():r&&r.clone?t[n]=r.clone():r&&Array.isArray(r)?t[n]=r.slice():i&&Array.isArray(i)?i.length=0:t[n]=r}(e,n,i)}))},setDefault:function(t,e,n){void 0===t[e]&&(t[e]=n)},setDefaults:f,kindDefaults:function(t,e){return f(t,e,(function(t,e,n,i){return!(e.search(/[fF]lags$/)<0)&&(n?"string"==typeof n?n=n.split(/[,|]/).map((t=>t.trim())):Array.isArray(n)||(n=[n]):n=[],"string"==typeof i?i=i.split(/[,|]/).map((t=>t.trim())):Array.isArray(i)||(i=[i]),t[e]=i.concat(n),!0)}))},pick:function(t,...e){const n={};return e.forEach((e=>{const i=t[e];void 0!==i&&(n[e]=i)})),n},clearObject:function(t){Object.keys(t).forEach((e=>t[e]=void 0))},ERROR:a,WARN:d,getOpt:function(t,e,n){const i=t[e];return void 0===i?n:i},firstOpt:function(t,...e){for(let n of e){if("object"!=typeof n||Array.isArray(n))return n;if(void 0!==n[t])return n[t]}},arraysIntersect:function(t,e){return t.some((t=>e.includes(t)))},sum:function(t){return t.reduce(((t,e)=>t+e))},chainLength:function(t){let e=0;for(;t;)e+=1,t=t.next;return e},chainIncludes:function(t,e){for(;t&&t!==e;)t=t.next;return t===e},eachChain:p,addToChain:y,removeFromChain:g};const w={make:()=>Math.random.bind(Math)};function _(t,e){let n,i,r;for(i=0,n=0;n<e.length;n++)i+=e[n];if(i<=0)return console.warn("Lottery Draw - no frequencies",e,e.length),0;for(r=t.range(0,i-1),n=0;n<e.length;n++){if(e[n]>r)return n;r-=e[n]}return console.warn("Lottery Draw failed.",e,e.length),0}class x{constructor(){this._fn=w.make()}static configure(t){if(t.make){if("function"!=typeof t.make)throw new Error("Random make parameter must be a function.");if("function"!=typeof t.make(12345))throw new Error("Random make function must accept a numeric seed and return a random function.");w.make=t.make,E.seed(),v.seed()}}seed(t){this._fn=w.make(t)}value(){return this._fn()}float(){return this.value()}number(t=0){return t=t||Number.MAX_SAFE_INTEGER,Math.floor(this._fn()*t)}int(t=0){return this.number(t)}range(t,e){if(e<=t)return e;const n=e-t+1;return t+this.number(n)}dice(t,e,n=0){let i=0,r=1;t<0&&(t=-t,r=-1),n=n||0;for(let n=0;n<t;++n)i+=this.range(1,e);return i*=r,i+n}weighted(t){return Array.isArray(t)?_(this,t):function(t,e){const n=Object.entries(e),i=n.map((([t,e])=>e));return n[_(t,i)][0]}(this,t)}item(t){return Array.isArray(t)||(t=Object.values(t)),t[this.range(0,t.length-1)]}key(t){return this.item(Object.keys(t))}shuffle(t,e=0,n=0){let i,r,o;for(2==arguments.length&&(n=e,e=0),n=n||t.length,i=e=e||0;i<n;i++)r=this.range(e,n-1),i!=r&&(o=t[r],t[r]=t[i],t[i]=o);return t}sequence(t){const e=[];for(let n=0;n<t;n++)e[n]=n;return this.shuffle(e)}chance(t,e=100){return!(t<=0)&&(t>=e||this.number(e)<t)}clumped(t,e,n){if(e<=t)return t;if(n<=1)return this.range(t,e);let i,r=0,o=Math.floor((e-t)/n);for(i=0;i<(e-t)%n;i++)r+=this.range(0,o+1);for(;i<n;i++)r+=this.range(0,o);return r+t}}const E=new x,v=new x;class b{constructor(t,e=0,n=1,i){this._rng=i||E,Array.isArray(t)?(n=t[2],e=t[1],t=t[0]):t instanceof b&&(n=t.clumps,e=t.hi,t=t.lo),e<t&&([e,t]=[t,e]),this.lo=t||0,this.hi=e||this.lo,this.clumps=n||1}value(){return this._rng.clumped(this.lo,this.hi,this.clumps)}toString(){return this.lo>=this.hi?""+this.lo:`${this.lo}-${this.hi}`}}var M={__proto__:null,Range:b,make:function(t,e){if(!t)return new b(0,0,0,e);if(t instanceof b)return t;if("function"==typeof t)throw new Error("Custom range functions not supported - extend Range");if(null==t)return new b(0,0,0,e);if("number"==typeof t)return new b(t,t,1,e);if(!0===t||!1===t)throw new Error("Invalid random config: "+t);if(Array.isArray(t))return new b(t[0],t[1],t[2],e);if("string"!=typeof t)throw new Error("Calculations must be strings.  Received: "+JSON.stringify(t));if(0==t.length)return new b(0,0,0,e);const n=/^(?:([+-]?\d*)[Dd](\d+)([+-]?\d*)|([+-]?\d+)-(\d+):?(\d+)?|([+-]?\d+)~(\d+)|([+-]?\d+\.?\d*))/g;let i;for(;null!==(i=n.exec(t));){if(i[2]){let t=Number.parseInt(i[1])||1;const n=Number.parseInt(i[2]),r=Number.parseInt(i[3])||0;return new b(r+t,r+t*n,t,e)}if(i[4]&&i[5]){const t=Number.parseInt(i[4]),n=Number.parseInt(i[5]),r=Number.parseInt(i[6]);return new b(t,n,r,e)}if(i[7]&&i[8]){const t=Number.parseInt(i[7]),n=Number.parseInt(i[8]);return new b(t-2*n,t+2*n,3,e)}if(i[9]){const t=Number.parseFloat(i[9]);return new b(t,t,1,e)}}throw new Error("Not a valid range - "+t)}};const R={};var k={__proto__:null,fl:function(t){return 1<<t},toString:function(t,e){const n=Object.entries(t).reduce(((t,e)=>{const[n,i]=e;return i&&(t[i]=n),t}),[]),i=[];for(let t=0;t<32;++t){const r=1<<t;e&r&&i.push(n[r])}return i.join(" | ")},from:function(t,...e){let n=0;for(let i=0;i<e.length;++i){let r=e[i];void 0!==r&&("number"!=typeof r?("string"==typeof r&&(r=r.split(/[,|]/).map((t=>t.trim())).map((t=>{const e=Number.parseInt(t);return e>=0?e:t}))),Array.isArray(r)&&r.forEach((e=>{if("string"==typeof e)if((e=e.trim()).startsWith("!")){const i=t[e.substring(1)];n&=~i}else{const i=t[e];i&&(n|=i)}else 0===e?n=0:n|=e}))):n|=r)}return n},flags:R,install:function(t,e){return R[t]=e,e}};const A=e,L=n;function N(t,e){if(void 0===e)return new Array(t).fill(0);e=e||(()=>0);const n=new Array(t);for(let i=0;i<t;++i)n[i]=e(i);return n}function O(t){return!1===t?" ":!0===t?"T":t<10?""+t:t<36?String.fromCharCode("a".charCodeAt(0)+t-10):t<62?String.fromCharCode("A".charCodeAt(0)+t-10-26):"string"==typeof t?t[0]:"#"}class I extends Array{constructor(t,e,n){super(t);for(let i=0;i<t;++i)this[i]="function"==typeof n?new Array(e).fill(0).map(((t,e)=>n(i,e))):new Array(e).fill(n);this._width=t,this._height=e}get width(){return this._width}get height(){return this._height}forEach(t){let e,n;for(e=0;e<this.width;e++)for(n=0;n<this.height;n++)t(this[e][n],e,n,this)}eachNeighbor(t,e,n,i=!1){const r=i?4:8;for(let i=0;i<r;++i){const r=A[i],o=t+r[0],s=e+r[1];this.hasXY(o,s)&&n(this[o][s],o,s,this)}}forRect(t,e,n,i,r){n=Math.min(this.width-t,n),i=Math.min(this.height-e,i);for(let o=t;o<t+n;++o)for(let t=e;t<e+i;++t)r(this[o][t],o,t,this)}map(t){return super.map(((e,n)=>e.map(((e,i)=>t(e,n,i,this)))))}forCircle(t,e,n,i){let r,o;for(r=Math.max(0,t-n-1);r<Math.min(this.width,t+n+1);r++)for(o=Math.max(0,e-n-1);o<Math.min(this.height,e+n+1);o++)this.hasXY(r,o)&&(r-t)*(r-t)+(o-e)*(o-e)<n*n+n&&i(this[r][o],r,o,this)}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}isBoundaryXY(t,e){return this.hasXY(t,e)&&(0==t||t==this.width-1||0==e||e==this.height-1)}calcBounds(){const t={left:this.width,top:this.height,right:0,bottom:0};return this.forEach(((e,n,i)=>{e&&(t.left>n&&(t.left=n),t.right<n&&(t.right=n),t.top>i&&(t.top=i),t.bottom<i&&(t.bottom=i))})),t}update(t){let e,n;for(e=0;e<this.width;e++)for(n=0;n<this.height;n++)this[e][n]=t(this[e][n],e,n,this)}updateRect(t,e,n,i,r){let o,s;for(o=t;o<t+n;o++)for(s=e;s<e+i;s++)this.hasXY(o,s)&&(this[o][s]=r(this[o][s],o,s,this))}updateCircle(t,e,n,i){let r,o;for(r=Math.max(0,t-n-1);r<Math.min(this.width,t+n+1);r++)for(o=Math.max(0,e-n-1);o<Math.min(this.height,e+n+1);o++)this.hasXY(r,o)&&(r-t)*(r-t)+(o-e)*(o-e)<n*n+n&&(this[r][o]=i(this[r][o],r,o,this))}fill(t){const e="function"==typeof t?t:()=>t;this.update(e)}fillRect(t,e,n,i,r){const o="function"==typeof r?r:()=>r;this.updateRect(t,e,n,i,o)}fillCircle(t,e,n,i){const r="function"==typeof i?i:()=>i;this.updateCircle(t,e,n,r)}replace(t,e){this.update((n=>n==t?e:n))}copy(t){this.update(((e,n,i)=>t[n][i]))}count(t){const e="function"==typeof t?t:e=>e==t;let n=0;return this.forEach(((t,i,r)=>{e(t,i,r,this)&&++n})),n}dump(t){this.dumpRect(0,0,this.width,this.height,t)}dumpRect(t,e,n,i,r){let s,h;r=r||O,t=o(t,0,this.width-2),e=o(e,0,this.height-2);const u=o(t+n,1,this.width-1),l=o(e+i,1,this.height-1);let c=[];for(h=e;h<=l;h++){let e=(h+"]").padStart(3," ");for(s=t;s<=u;s++){s%10==0&&(e+=" ");e+=r(this[s][h],s,h)[0]}c.push(e)}console.log(c.join("\n"))}dumpAround(t,e,n){this.dumpRect(t-n,e-n,2*n,2*n)}closestMatchingLoc(t,e,n){let i=[-1,-1],r=this.width+this.height;return this.forEach(((o,s,h)=>{if(n(o,s,h,this)){const n=u(t,e,s,h);n<r?(i[0]=s,i[1]=h,r=n):n==r&&E.chance(50)&&(i[0]=s,i[1]=h)}})),i}firstMatchingLoc(t){const e="function"==typeof t?t:e=>e==t;for(let t=0;t<this.width;++t)for(let n=0;n<this.height;++n)if(e(this[t][n],t,n,this))return[t,n];return[-1,-1]}randomMatchingLoc(t,e=!1){let n,i,r,o=0;const s="function"==typeof t?t:e=>e==t;if(o=0,this.forEach(((t,e,n)=>{s(t,e,n,this)&&o++})),0==o)return[-1,-1];for(r=e?Math.floor(o/2):E.range(0,o-1),n=0;n<this.width&&r>=0;n++)for(i=0;i<this.height&&r>=0;i++)if(s(this[n][i],n,i,this)){if(0==r)return[n,i];r--}return[-1,-1]}matchingLocNear(t,e,n,i=!1){let r,o,s,h,u,l=[-1,-1];const c="function"==typeof n?n:t=>t==n;for(h=0,s=0;s<Math.max(this.width,this.height)&&!h;s++)for(r=t-s;r<=t+s;r++)for(o=e-s;o<=e+s;o++)this.hasXY(r,o)&&(r==t-s||r==t+s||o==e-s||o==e+s)&&c(this[r][o],r,o,this)&&h++;if(0==h)return[-1,-1];for(u=i?1+Math.floor(h/2):1+E.number(h),s=0;s<Math.max(this.width,this.height);s++)for(r=t-s;r<=t+s;r++)for(o=e-s;o<=e+s;o++)if(this.hasXY(r,o)&&(r==t-s||r==t+s||o==e-s||o==e+s)&&c(this[r][o],r,o,this)&&0==--u)return l[0]=r,l[1]=o,l;return[-1,-1]}arcCount(t,e,n){let i,o,s,h,u,l;for(n=n||r,i=0,o=0;o<L.length;o++)s=t+L[(o+7)%8][0],h=e+L[(o+7)%8][1],u=t+L[o][0],l=e+L[o][1],(this.hasXY(u,l)&&n(this[u][l],u,l,this))!=(this.hasXY(s,h)&&n(this[s][h],s,h,this))&&i++;return Math.floor(i/2)}}const T=[];class C extends I{constructor(t,e,n=0){super(t,e,n)}static alloc(t,e,n=0){if(!t||!e)throw new Error("Grid alloc requires width and height parameters.");let i=T.pop();return i?(i.resize(t,e,n),i):new C(t,e,n)}static free(t){if(t){if(T.indexOf(t)>=0)return;T.push(t)}}resize(t,e,n=0){const i="function"==typeof n?n:()=>n;for(;this.length<t;)this.push([]);this.length=t;let r=0,o=0;for(r=0;r<t;++r){const t=this[r];for(o=0;o<e;++o)t[o]=i(r,o);t.length=e}this._width=t,this._height=e,void 0!==this.x&&(this.x=void 0,this.y=void 0)}findReplaceRange(t,e,n){this.update((i=>i>=t&&i<=e?n:i))}floodFillRange(t,e,n=0,i=0,r=0){let o,s,h,u=1;if(r>=n&&r<=i)throw new Error("Invalid grid flood fill");for(this[t][e]=r,o=0;o<4;o++)s=t+A[o][0],h=e+A[o][1],this.hasXY(s,h)&&this[s][h]>=n&&this[s][h]<=i&&(u+=this.floodFillRange(s,h,n,i,r));return u}invert(){this.update((t=>t?0:1))}closestLocWithValue(t,e,n=1){return this.closestMatchingLoc(t,e,(t=>t==n))}randomLocWithValue(t=1){return this.randomMatchingLoc((e=>e==t))}getQualifyingLocNear(t,e,n=!1){return this.matchingLocNear(t,e,(t=>!!t),n)}leastPositiveValue(){let t=Number.MAX_SAFE_INTEGER;return this.forEach((e=>{e>0&&e<t&&(t=e)})),t}randomLeastPositiveLoc(t=!1){const e=this.leastPositiveValue();return this.randomMatchingLoc((t=>t==e),t)}floodFill(t,e,n,i){let r,o,s,h=1;const u="function"==typeof n?n:t=>t==n,l="function"==typeof i?i:()=>i;for(this[t][e]=l(this[t][e],t,e,this),r=0;r<4;r++)o=t+A[r][0],s=e+A[r][1],this.hasXY(o,s)&&u(this[o][s],o,s,this)&&(h+=this.floodFill(o,s,u,l));return h}_cellularAutomataRound(t,e){let n,i,r,o,s,h,u;u=C.alloc(this.width,this.height),u.copy(this);let l=!1;for(n=0;n<this.width;n++)for(i=0;i<this.height;i++){for(r=0,h=0;h<A.length;h++)o=n+A[h][0],s=i+A[h][1],this.hasXY(o,s)&&u[o][s]&&r++;u[n][i]||"t"!=t[r]?u[n][i]&&"t"==e[r]||(this[n][i]=0,l=!0):(this[n][i]=1,l=!0)}return C.free(u),l}fillBlob(t,e,n,i,r,o,s,h){let u,l,c,f,a,d,p,y,g,m,w,_,x,v;e>=i&&(e=Math.round(.75*i),i=Math.round(1.25*i)),n>=r&&(n=Math.round(.75*r),r=Math.round(1.25*r));const b=Math.floor((this.width-i)/2),M=Math.floor((this.height-r)/2);do{for(this.fill(0),u=0;u<i;u++)for(l=0;l<r;l++)this[u+b][l+M]=E.chance(o)?1:0;for(c=0;c<t;c++)this._cellularAutomataRound(s,h)||(c=t);for(p=0,d=0,y=this.width,m=0,g=this.height,w=0,f=2,u=0;u<this.width;u++)for(l=0;l<this.height;l++)1==this[u][l]&&(a=this.floodFill(u,l,1,f),a>p&&(p=a,d=f),f++);for(u=0;u<this.width;u++){for(v=!1,l=0;l<this.height;l++)if(this[u][l]==d){v=!0;break}v&&(u<y&&(y=u),u>m&&(m=u))}for(l=0;l<this.height;l++){for(v=!1,u=0;u<this.width;u++)if(this[u][l]==d){v=!0;break}v&&(l<g&&(g=l),l>w&&(w=l))}_=m-y+1,x=w-g+1}while(_<e||x<n||0==d);for(u=0;u<this.width;u++)for(l=0;l<this.height;l++)this[u][l]==d?this[u][l]=1:this[u][l]=0;return{x:y,y:g,width:_,height:x}}}const K=C.alloc.bind(C),X=C.free.bind(C);var Y={__proto__:null,makeArray:N,Grid:I,NumGrid:C,alloc:K,free:X,make:function(t,e,n){return void 0===n?new C(t,e,0):"number"==typeof n?new C(t,e,n):new I(t,e,n)},offsetZip:function(t,e,n,i,r){const o="function"==typeof r?r:(e,n,i,o)=>t[i][o]=r||n;e.forEach(((r,s,h)=>{const u=s+n,l=h+i;t.hasXY(u,l)&&r&&o(t[u][l],r,u,l,s,h,t,e)}))},directionOfDoorSite:function(t,e,n,i){let r,o,s,h,u,l;const c="function"==typeof i?i:t=>t==i;for(o=-1,r=0;r<4;r++)if(s=e+A[r][0],h=n+A[r][1],u=e-A[r][0],l=n-A[r][1],t.hasXY(u,l)&&t.hasXY(s,h)&&c(t[u][l],u,l,t)){if(-1!=o)return-1;o=r}return o},intersection:function(t,e,n){n=n||t,t.update(((t,i,r)=>e[i][r]&&n[i][r]))},unite:function(t,e,n){n=n||t,t.update(((t,i,r)=>n[i][r]||e[i][r]))}},D={};let S={};const F=[],P=[],j={x:-1,y:-1},U="keypress",V="mousemove",W="click",B="tick",G="mouseup",H=["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight"];var q=null,$=null;async function z(t,e){let n,i;return"function"==typeof(e=e||S)?i=e:t.dir?i=e.dir:t.type===U?i=e[t.key]||e[t.code]||e.keypress:e[t.type]&&(i=e[t.type]),i&&("function"==typeof i?n=await i.call(e,t):D[i]?n=await D[i](t):d("No command found: "+i)),"next"in e&&!1===e.next&&(n=!1),Q(t),n}function Q(t){P.push(t)}function Z(t){const e=t.toLowerCase();return"arrowup"===e?[0,-1]:"arrowdown"===e?[0,1]:"arrowleft"===e?[-1,0]:"arrowright"===e?[1,0]:null}var J={x:-1,y:-1};function tt(t,e){e=e||i;let n,r=0;for(;F.length;){const t=F.shift();if(t.type===V&&(J.x=t.x,J.y=t.y),e(t))return Promise.resolve(t);Q(t)}return void 0===t&&(t=-1),0==t?Promise.resolve(null):(q?console.warn("OVERWRITE HANDLER - nextEvent"):F.length&&console.warn("SET HANDLER WITH QUEUED EVENTS - nextEvent"),q=i=>{if(i.type===V&&(J.x=i.x,J.y=i.y),i.type===B&&t>0){if(r+=i.dt,r<t)return}else if(!e(i))return;q=null,i.dt=r,n(i)},new Promise((t=>n=t)))}async function et(t,e){return void 0===t&&(t=-1),e=e||i,tt(t,(function(t){return(t.type===U||t.type===W)&&e(t)}))}async function nt(t){const e=await et(t);return e&&e.type!==B}var it={__proto__:null,commands:D,addCommand:function(t,e){D[t]=e},KEYPRESS:U,MOUSEMOVE:V,CLICK:W,TICK:B,MOUSEUP:G,setKeymap:function(t){S=t},hasEvents:function(){return F.length},clearEvents:function(){for(;F.length;){const t=F.shift();P.push(t)}},pushEvent:function(t){if($&&console.log("PAUSED EVENT",t.type),F.length){const e=F[F.length-1];if(e.type===t.type&&e.type===V)return e.x=t.x,e.y=t.y,void Q(t)}if(t.type===W){if(j.x==t.x&&j.y==t.y)return void Q(t);j.x=t.x,j.y=t.y}else if(t.type==G)return j.x=-1,j.y=-1,void Q(t);if(q)q(t);else if(t.type===B){const e=F[0];if(e&&e.type===B)return e.dt+=t.dt,void Q(t);F.unshift(t)}else F.push(t)},dispatchEvent:z,makeTickEvent:function(t){const e=P.pop()||{};return e.shiftKey=!1,e.ctrlKey=!1,e.altKey=!1,e.metaKey=!1,e.type=B,e.key=null,e.code=null,e.x=-1,e.y=-1,e.dir=null,e.dt=t,e},makeKeyEvent:function(t){let e=t.key,n=t.code.toLowerCase();t.shiftKey&&(e=e.toUpperCase(),n=n.toUpperCase()),t.ctrlKey&&(e="^"+e,n="^"+n),t.metaKey&&(e="#"+e,n="#"+n),t.altKey&&(n="/"+n);const i=P.pop()||{};return i.shiftKey=t.shiftKey,i.ctrlKey=t.ctrlKey,i.altKey=t.altKey,i.metaKey=t.metaKey,i.type=U,i.key=e,i.code=n,i.x=-1,i.y=-1,i.clientX=-1,i.clientY=-1,i.dir=Z(t.code),i.dt=0,i},keyCodeDirection:Z,ignoreKeyEvent:function(t){return H.includes(t.code)},mouse:J,makeMouseEvent:function(t,e,n){const i=P.pop()||{};return i.shiftKey=t.shiftKey,i.ctrlKey=t.ctrlKey,i.altKey=t.altKey,i.metaKey=t.metaKey,i.type=t.type,t.buttons&&"mouseup"!==t.type&&(i.type=W),i.key=null,i.code=null,i.x=e,i.y=n,i.clientX=t.clientX,i.clientY=t.clientY,i.dir=null,i.dt=0,i},pauseEvents:function(){$||($=q,q=null)},resumeEvents:function(){if($&&(q&&console.warn("overwrite CURRENT HANDLER!"),q=$,$=null,F.length&&q)){const t=F.shift();q(t)}},nextEvent:tt,tickMs:async function(t=1){let e;return setTimeout((()=>e()),t),new Promise((t=>e=t))},nextKeyPress:async function(t,e){return void 0===t&&(t=-1),e=e||i,tt(t,(function(t){return t.type===U&&e(t)}))},nextKeyOrClick:et,pause:nt,waitForAck:function(){return nt(3e5)},loop:async function(t){let e=!0;for(;e;){const n=await tt();n&&await z(n,t)&&(e=!1)}}};var rt={__proto__:null,FOV:class{constructor(t){this._startX=-1,this._startY=-1,this._maxRadius=100,this._isBlocked=t.isBlocked,this._calcRadius=t.calcRadius||l,this._setVisible=t.setVisible,this._hasXY=t.hasXY||i}calculate(t,n,i){this._setVisible(t,n,1),this._startX=t,this._startY=n,this._maxRadius=i+1;for(let t=4;t<8;++t){const n=e[t];this.castLight(1,1,0,0,n[0],n[1],0),this.castLight(1,1,0,n[0],0,0,n[1])}}castLight(t,e,n,i,r,o,s){if(t>=this._maxRadius)return;if(e<n)return;let h,u,l,c,f,a=e,d=!1,p=-t,y=0;for(let g=-t;g<=0;g++){if(h=Math.floor(this._startX+g*i+p*r),u=Math.floor(this._startY+g*o+p*s),l=(g-.5)/(p+.5),c=(g+.5)/(p-.5),f=g/(p+.5),y=(g+.5)/p,!this._hasXY(h,u)){d=!0;continue}if(e<y){d=this._isBlocked(h,u);continue}if(n>f)break;const m=this._calcRadius(g,p);if(m<this._maxRadius){const t=1-m/this._maxRadius;this._setVisible(h,u,t)}if(d){if(this._isBlocked(h,u)){a=c;continue}d=!1}else this._isBlocked(h,u)&&t<this._maxRadius&&(d=!0,this.castLight(t+1,a,l,i,r,o,s),a=c)}d||this.castLight(t+1,a,n,i,r,o,s)}}};const ot=3e4;function st(t){return{distance:0,cost:0,index:t,left:null,right:null}}function ht(t,e,n){return t.links[e+t.width*n]}const ut=e;function lt(t,e,n){return e<=0||n<=0||(e>=t.length-1||n>=t[0].length-1)}function ct(t,e){let n,i;for(function(t){let e,n,i,r=null,o=null,s=null;n=t.eightWays?8:4;let h=t.front.right;for(t.front.right=null;null!=h;){for(e=0;e<n;e++){if(i=h.index+(ut[e][0]+t.width*ut[e][1]),i<0||i>=t.width*t.height)continue;if(s=t.links[i],s.cost<0)continue;let n=0;if(e>=4){let i,r,o,s;if(n=.4142,r=h.index+ut[e][0],r<0||r>=t.width*t.height)continue;if(s=h.index+t.width*ut[e][1],s<0||s>=t.width*t.height)continue;if(i=t.links[r],o=t.links[s],-2==i.cost||-2==o.cost)continue}if(h.distance+s.cost+n<s.distance){for(s.distance=h.distance+s.cost+n,null!=s.right&&(s.right.left=s.left),null!=s.left&&(s.left.right=s.right),r=h,o=h.right;null!=o&&o.distance<s.distance;)r=o,o=o.right;null!=r&&(r.right=s),s.right=o,s.left=r,null!=o&&(o.left=s)}}o=h.right,h.left=null,h.right=null,h=o}}(t),n=0;n<t.width;n++)for(i=0;i<t.height;i++)e[n][i]=ht(t,n,i).distance}var ft;function at(t,n,i,r,o=!1){let s,h,u,l,c,f;for(u=0,c=-1,l=0;l<(o?8:4);++l)s=n+e[l][0],h=i+e[l][1],f=r(s,h,n,i,t),!f&&t[n][i]-t[s][h]>u&&(c=l,u=t[n][i]-t[s][h]);return e[c]||null}var dt={__proto__:null,FORBIDDEN:-1,OBSTRUCTION:-2,AVOIDED:10,NO_PATH:ot,calculateDistances:function(t,e,n,i,r=!1){const o=t.length,s=t[0].length;var h,u;let l,c;for((!ft||ft.width<o||ft.height<s)&&(h=o,u=s,ft={eightWays:!1,front:st(-1),links:N(h*u,(t=>st(t))),width:h,height:u}),ft.width=o,ft.height=s,l=0;l<o;l++)for(c=0;c<s;c++)ht(ft,l,c).cost=lt(i,l,c)?-2:i[l][c];!function(t,e,n){let i;for(t.eightWays=n,t.front.right=null,i=0;i<t.width*t.height;i++)t.links[i].distance=e,t.links[i].left=t.links[i].right=null}(ft,ot,r),function(t,e,n,i){let r,o,s;if(e>0&&n>0&&e<t.width-1&&n<t.height-1&&(s=ht(t,e,n),s.distance>i)){for(s.distance=i,null!=s.right&&(s.right.left=s.left),null!=s.left&&(s.left.right=s.right),r=t.front,o=t.front.right;null!=o&&o.distance<s.distance;)r=o,o=o.right;s.right=o,s.left=r,r.right=s,null!=o&&(o.left=s)}}(ft,e,n,0),ct(ft,t)},nextStep:at,getPath:function(t,e,n,i){let r=e,o=n,s=0;if(t[r][o]<0||t[r][o]>=ot){const e=function(t,e,n){let i,r,o,s,h,u=-1,l=-1;const c=t.length,f=t[0].length;for(s=1e4,h=1e4,i=1;i<c-1;i++)for(r=1;r<f-1;r++)t[i][r]>=0&&t[i][r]<ot&&(o=(i-e)*(i-e)+(r-n)*(r-n),(o<s||o==s&&t[i][r]<h)&&(u=i,l=r,s=o,h=t[i][r]));return u>=0?[u,l]:null}(t,r,o);e&&(r=e[0],o=e[1])}const h=[[r,o]];let u;do{u=at(t,r,o,i,!0),u&&(r+=u[0],o+=u[1],h.push([r,o]),s++)}while(u);return s?h:null}};class pt{constructor(t,e,n=!1){this.fn=t,this.context=e||null,this.once=n||!1,this.next=null}matches(t,e,n){return!(this.fn!==t||void 0!==n&&n!=this.once||e&&this.context!==e)}}var yt={};function gt(t,e,n,i=!1){if("function"!=typeof e)throw new TypeError("The listener must be a function");const r=new pt(e,n||null,i);return y(yt,t,r),r}function mt(t,e,n,i=!1){yt[t]&&(e?p(yt[t],(r=>{const o=r;o.matches(e,n,i)&&g(yt,t,o)})):wt(t))}function wt(t){yt[t]=null}var _t={__proto__:null,Listener:pt,addListener:gt,on:function(t,e,n,i=!1){return gt(t,e,n,i)},once:function(t,e,n){return gt(t,e,n,!0)},removeListener:mt,off:function(t,e,n,i=!1){mt(t,e,n,i)},clearEvent:wt,removeAllListeners:function(t){t?yt[t]&&wt(t):yt={}},emit:async function(...t){const e=t[0];if(!yt[e])return!1;let n=yt[e];for(;n;){let i=n.next;n.once&&g(yt,e,n),await n.fn.apply(n.context,t),n=i}return!0}};t.Random=x,t.cosmetic=v,t.data={},t.events=_t,t.flag=k,t.flags=R,t.fov=rt,t.grid=Y,t.io=it,t.path=dt,t.random=E,t.range=M,t.utils=m,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-core.min.js.map
