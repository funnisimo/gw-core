!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rot-js")):"function"==typeof define&&define.amd?define(["exports","rot-js"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.ROT)}(this,(function(t,e){"use strict";function n(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,e}var i=n(e);const r=[[0,-1],[1,0],[0,1],[-1,0],[1,-1],[1,1],[-1,1],[-1,-1]],s=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];function o(){}function h(){return!0}function u(t,e,n){return t<e?e:t>n?n:t}function a(t){return t.x||t[0]||0}function l(t){return t.y||t[1]||0}class c{constructor(t,e,n,i){this.x=t,this.y=e,this.width=n,this.height=i}get left(){return this.x}get right(){return this.x+this.width-1}get top(){return this.y}get bottom(){return this.y+this.height-1}contains(...t){let e=t[0],n=t[1];return"number"!=typeof e&&(n=n(e),e=e(e)),this.x<=e&&this.y<=n&&this.x+this.width>e&&this.y+this.height>n}}function f(t,e,n,i=!1){const s=i?4:8;for(let i=0;i<s;++i){const s=r[i];n(t+s[0],e+s[1])}}function d(t,e,n,i){const r=Math.abs(t-n),s=Math.abs(e-i);return r+s-.6*Math.min(r,s)}function g(t,e){return d(0,0,t,e)}function _(t,e,n,i){let r=n-t,s=i-e;if(r&&s){const t=Math.abs(r),e=Math.abs(s);t>=2*e?s=0:e>=2*t&&(r=0)}return[Math.sign(r),Math.sign(s)]}function p(t,e,n){const i=t[n],r=e[n];i&&i.copy&&r?i.copy(r):i&&i.clear&&!r?i.clear():i&&i.nullify&&!r?i.nullify():r&&r.clone?t[n]=r.clone():r&&Array.isArray(r)?t[n]=r.slice():i&&Array.isArray(i)?i.length=0:t[n]=r}function m(t,e,n=null){let i;e&&Object.keys(e).forEach((r=>{const s=r;let o=e[r];i=t;const h=r.split(".");for(;h.length>1;)r=h.shift(),void 0===i[r]?i=i[r]={}:"object"!=typeof i[r]?E("Trying to set default member on non-object config item: "+s):i=i[r];r=h.shift();let u=i[r];n&&n(i,r,u,o)||void 0===u&&(null===o?i[r]=null:Array.isArray(o)?i[r]=o.slice():i[r]=o)}))}function E(t){throw new Error(t)}function y(...t){console.warn(...t)}function b(...t){return t.find((t=>void 0!==t))}function w(t,e){let n=0;for(;t;){const i=t.next;e(t,n++),t=i}return n}function x(t,e,n){return n.next=t[e]||null,t[e]=n,!0}function R(t,e,n){const i=t[e];if(i===n)return t[e]=n.next||null,n.next=null,!0;if(!i)return!1;{let t=i,e=t.next;for(;e&&e!==n;)t=e,e=t.next;if(e===n)return t.next=e.next||null,n.next=null,!0}return!1}const v=65536;function A(t,e,n,i,r){let s,o,h=[],u=[],a=[],l=[],c=[],f=[-1,-1],d=[-1,-1];if(t==n&&e==i)return;const g=[t,e],_=[n,i];for(o=0;o<=1;o++)h[o]=_[o]-g[o]<<16,h[o]<0?(h[o]*=-1,c[o]=-1):c[o]=1,a[o]=l[o]=u[o]=0,f[o]=g[o];for(s=Math.max(h[0],h[1]),h[0]=Math.floor(h[0]*v/s),h[1]=Math.floor(h[1]*v/s);;){for(o=0;o<=1;o++)d[o]=f[o],a[o]+=h[o]>>16,u[o]+=h[o]==v?0:h[o],u[o]>=Math.floor(32768)&&(a[o]++,u[o]-=v),f[o]=Math.floor(c[o]*a[o]+g[o]);if(r(...f))break}}function S(t,e,n,i){let r,s;for(r=t-n-1;r<t+n+1;r++)for(s=e-n-1;s<e+n+1;s++)(r-t)*(r-t)+(s-e)*(s-e)<n*n+n&&i(r,s)}function T(...t){let e=0,n=0;arguments.length>3&&(e=t.shift(),n=t.shift());const i=e+t[0],r=n+t[1],s=t[2];for(let t=e;t<i;++t)for(let e=n;e<r;++e)s(t,e)}function C(t,e,n){let i,r,o,h,u=0,a=0;for(let l=0;l<s.length;l++){i=t+s[(l+7)%8][0],r=e+s[(l+7)%8][1],o=t+s[l][0],h=e+s[l][1];const c=n(o,h);c&&++a,c!=n(i,r)&&u++}return 0==u&&a?1:Math.floor(u/2)}var M={__proto__:null,DIRS:r,NO_DIRECTION:-1,UP:0,RIGHT:1,DOWN:2,LEFT:3,RIGHT_UP:4,RIGHT_DOWN:5,LEFT_DOWN:6,LEFT_UP:7,CLOCK_DIRS:s,NOOP:o,TRUE:h,FALSE:function(){return!1},ONE:function(){return 1},ZERO:function(){return 0},IDENTITY:function(t){return t},IS_ZERO:function(t){return 0==t},IS_NONZERO:function(t){return 0!=t},clamp:u,x:a,y:l,Bounds:c,copyXY:function(t,e){t.x=a(e),t.y=l(e)},addXY:function(t,e){t.x+=a(e),t.y+=l(e)},equalsXY:function(t,e){return!t&&!e||!(!t||!e)&&(a(t)==a(e)&&l(t)==l(e))},lerpXY:function(t,e,n){n>1&&(n/=100),n=u(n,0,1);const i=a(e)-a(t),r=l(e)-l(t);return[a(t)+Math.floor(i*n),l(t)+Math.floor(r*n)]},eachNeighbor:f,matchingNeighbor:function(t,e,n,i=!1){const s=i?4:8;for(let i=0;i<s;++i){const s=r[i],o=t+s[0],h=e+s[1];if(n(o,h))return[o,h]}return[-1,-1]},distanceBetween:d,distanceFromTo:function(t,e){return d(a(t),l(t),a(e),l(e))},calcRadius:g,dirBetween:_,dirFromTo:function(t,e){return _(a(t),l(t),a(e),l(e))},dirIndex:function(t){const e=a(t),n=l(t);return r.findIndex((t=>t[0]==e&&t[1]==n))},isOppositeDir:function(t,e){return t[0]+e[0]==0&&t[1]+e[1]==0},isSameDir:function(t,e){return t[0]==e[0]&&t[1]==e[1]},dirSpread:function(t){const e=[t];return 0==t[0]?(e.push([1,t[1]]),e.push([-1,t[1]])):0==t[1]?(e.push([t[0],1]),e.push([t[0],-1])):(e.push([t[0],0]),e.push([0,t[1]])),e},stepFromTo:function(t,e,n){const i=a(t),r=l(t),s=[a(e)-i,l(e)-r],o=Math.abs(s[0])+Math.abs(s[1]),h=[0,0],u=[99999,99999];for(let t=0;t<=o;++t)h[0]=i+Math.floor(s[0]*t/o),h[1]=r+Math.floor(s[1]*t/o),h[0]==u[0]&&h[1]==u[1]||n(h[0],h[1]),u[0]=h[0],u[1]=h[1]},smoothHiliteGradient:function(t,e){return Math.floor(100*Math.sin(Math.PI*t/e))},copyObject:function(t,e){Object.keys(t).forEach((n=>{p(t,e,n)}))},assignObject:function(t,e){Object.keys(e).forEach((n=>{p(t,e,n)}))},assignOmitting:function(t,e,n){"string"==typeof t&&(t=t.split(/[,|]/g).map((t=>t.trim()))),Object.keys(n).forEach((i=>{t.includes(i)||p(e,n,i)}))},setDefault:function(t,e,n){void 0===t[e]&&(t[e]=n)},setDefaults:m,setOptions:function(t,e){m(t,e,((t,e,n,i)=>(null===i?t[e]=null:Array.isArray(i)?t[e]=i.slice():t[e]=i,!0)))},kindDefaults:function(t,e){return m(t,e,(function(t,e,n,i){return!(e.search(/[fF]lags$/)<0)&&(n?"string"==typeof n?n=n.split(/[,|]/).map((t=>t.trim())):Array.isArray(n)||(n=[n]):n=[],"string"==typeof i?i=i.split(/[,|]/).map((t=>t.trim())):Array.isArray(i)||(i=[i]),t[e]=i.concat(n),!0)}))},pick:function(t,...e){const n={};return e.forEach((e=>{const i=t[e];void 0!==i&&(n[e]=i)})),n},clearObject:function(t){Object.keys(t).forEach((e=>t[e]=void 0))},ERROR:E,WARN:y,first:b,getOpt:function(t,e,n){const i=t[e];return void 0===i?n:i},firstOpt:function(t,...e){for(let n of e){if("object"!=typeof n||Array.isArray(n))return n;if(void 0!==n[t])return n[t]}},arraysIntersect:function(t,e){return t.some((t=>e.includes(t)))},sum:function(t){return t.reduce(((t,e)=>t+e))},chainLength:function(t){let e=0;for(;t;)e+=1,t=t.next;return e},chainIncludes:function(t,e){for(;t&&t!==e;)t=t.next;return t===e},eachChain:w,addToChain:x,removeFromChain:R,forLine:A,getLine:function(t,e,n,i){const r=[];return A(t,e,n,i,((t,e)=>(r.push([t,e]),t==n&&e==i))),r},getLineThru:function(t,e,n,i,r,s){const o=[];return A(t,e,n,i,((t,e)=>t<0||e<0||t>=r||e>=s||(o.push([t,e]),!1))),o},forCircle:S,forRect:T,arcCount:C};function N(t,e){let n,i,r;for(i=0,n=0;n<e.length;n++)i+=e[n];if(i<=0)return-1;for(r=t.range(0,i-1),n=0;n<e.length;n++){if(e[n]>r)return n;r-=e[n]}return console.warn("Lottery Draw failed.",e,e.length),0}class I{constructor(){this._fn=i.RNG.clone()}seed(t){this._fn.setSeed(t)}value(){return this._fn.getUniform()}float(){return this.value()}number(t){return t<=0?0:(t=t||Number.MAX_SAFE_INTEGER,Math.floor(this.value()*t))}int(t=0){return this.number(t)}range(t,e){if(e<=t)return e;const n=e-t+1;return t+this.number(n)}dice(t,e,n=0){let i=0,r=1;t<0&&(t=-t,r=-1),n=n||0;for(let n=0;n<t;++n)i+=this.range(1,e);return i*=r,i+n}weighted(t){return Array.isArray(t)?N(this,t):function(t,e){const n=Object.entries(e),i=n.map((([t,e])=>e));return n[N(t,i)][0]}(this,t)}item(t){return Array.isArray(t)||(t=Object.values(t)),t[this.range(0,t.length-1)]}key(t){return this.item(Object.keys(t))}shuffle(t,e=0,n=0){let i,r,s;for(2==arguments.length&&(n=e,e=0),n=n||t.length,i=e=e||0;i<n;i++)r=this.range(e,n-1),i!=r&&(s=t[r],t[r]=t[i],t[i]=s);return t}sequence(t){const e=[];for(let n=0;n<t;n++)e[n]=n;return this.shuffle(e)}chance(t,e=100){return!(t<=0)&&(t>=e||this.number(e)<t)}clumped(t,e,n){if(e<=t)return t;if(n<=1)return this.range(t,e);let i,r=0,s=Math.floor((e-t)/n);for(i=0;i<(e-t)%n;i++)r+=this.range(0,s+1);for(;i<n;i++)r+=this.range(0,s);return r+t}matchingXY(t,e,n){let i,r,s,o=0;if(o=0,T(t,e,((t,e)=>{n(t,e)&&o++})),0==o)return[-1,-1];for(s=this.range(0,o-1),i=0;i<t&&s>=0;i++)for(r=0;r<e&&s>=0;r++)if(n(i,r)){if(0==s)return[i,r];s--}return[-1,-1]}matchingXYNear(t,e,n){let i,r,s,o,h,u=[-1,-1];for(o=0,s=0;s<50&&!o;s++)for(i=t-s;i<=t+s;i++)for(r=e-s;r<=e+s;r++)i!=t-s&&i!=t+s&&r!=e-s&&r!=e+s||!n(i,r)||o++;if(0==o)return[-1,-1];for(h=1+this.number(o),s=0;s<50;s++)for(i=t-s;i<=t+s;i++)for(r=e-s;r<=e+s;r++)if((i==t-s||i==t+s||r==e-s||r==e+s)&&n(i,r)&&0==--h)return u[0]=i,u[1]=r,u;return[-1,-1]}}const L=new I,O=new I,D={},U={},k={};class F{constructor(t,e=0,n=1,i){this._rng=i||L,Array.isArray(t)&&(n=t[2],e=t[1],t=t[0]),e<t&&([e,t]=[t,e]),this.lo=t||0,this.hi=e||this.lo,this.clumps=n||1}value(){return this._rng.clumped(this.lo,this.hi,this.clumps)}copy(t){return this.lo=t.lo,this.hi=t.hi,this.clumps=t.clumps,this._rng=t._rng,this}toString(){return this.lo>=this.hi?""+this.lo:`${this.lo}-${this.hi}`}}function P(t,e){if(!t)return new F(0,0,0,e);if(t instanceof F)return t;if("function"==typeof t)throw new Error("Custom range functions not supported - extend Range");if(null==t)return new F(0,0,0,e);if("number"==typeof t)return new F(t,t,1,e);if(!0===t||!1===t)throw new Error("Invalid random config: "+t);if(Array.isArray(t))return new F(t[0],t[1],t[2],e);if("string"!=typeof t)throw new Error("Calculations must be strings.  Received: "+JSON.stringify(t));if(0==t.length)return new F(0,0,0,e);const n=/^(?:([+-]?\d*)[Dd](\d+)([+-]?\d*)|([+-]?\d+)-(\d+):?(\d+)?|([+-]?\d+)~(\d+)|([+-]?\d+\.?\d*))/g;let i;for(;null!==(i=n.exec(t));){if(i[2]){let t=Number.parseInt(i[1])||1;const n=Number.parseInt(i[2]),r=Number.parseInt(i[3])||0;return new F(r+t,r+t*n,t,e)}if(i[4]&&i[5]){const t=Number.parseInt(i[4]),n=Number.parseInt(i[5]),r=Number.parseInt(i[6]);return new F(t,n,r,e)}if(i[7]&&i[8]){const t=Number.parseInt(i[7]),n=Number.parseInt(i[8]);return new F(t-2*n,t+2*n,3,e)}if(i[9]){const t=Number.parseFloat(i[9]);return new F(t,t,1,e)}}throw new Error("Not a valid range - "+t)}k.range=P;var Y={__proto__:null,Range:F,make:P,from:P,asFn:function(t,e){const n=P(t,e);return()=>n.value()}};function B(t){return 1<<t}function W(t,...e){let n=0;for(let i=0;i<e.length;++i){let r=e[i];void 0!==r&&("number"!=typeof r?("string"==typeof r&&(r=r.split(/[,|]/).map((t=>t.trim())).map((t=>{const e=Number.parseInt(t);return e>=0?e:t}))),Array.isArray(r)&&r.forEach((e=>{if("string"==typeof e)if((e=e.trim()).startsWith("!")){const i=t[e.substring(1)];n&=~i}else{const i=t[e];i&&(n|=i)}else 0===e?n=0:n|=e}))):n|=r)}return n}var H={__proto__:null,fl:B,toString:function(t,e){const n=Object.entries(t).reduce(((t,e)=>{const[n,i]=e;return"number"==typeof i&&(t[i]=n),t}),[]),i=[];for(let t=0;t<32;++t){const r=1<<t;e&r&&i.push(n[r])}return i.join(" | ")},from:W};const X=r;function G(t,e){if(void 0===e)return new Array(t).fill(0);e=e||(()=>0);const n=new Array(t);for(let i=0;i<t;++i)n[i]=e(i);return n}function K(t){return!1===t?" ":!0===t?"T":t<10?""+t:t<36?String.fromCharCode("a".charCodeAt(0)+t-10):t<62?String.fromCharCode("A".charCodeAt(0)+t-10-26):"string"==typeof t?t[0]:"#"}class j extends Array{constructor(t,e,n){super(t);for(let i=0;i<t;++i)this[i]="function"==typeof n?new Array(e).fill(0).map(((t,e)=>n(i,e))):new Array(e).fill(n);this._width=t,this._height=e}get width(){return this._width}get height(){return this._height}get(t,e){if(this.hasXY(t,e))return this[t][e]}set(t,e,n){return!!this.hasXY(t,e)&&(this[t][e]=n,!0)}forEach(t){let e,n;for(e=0;e<this.width;e++)for(n=0;n<this.height;n++)t(this[e][n],e,n,this)}async forEachAsync(t){let e,n;for(e=0;e<this.width;e++)for(n=0;n<this.height;n++)await t(this[e][n],e,n,this)}eachNeighbor(t,e,n,i=!1){f(t,e,((t,e)=>{this.hasXY(t,e)&&n(this[t][e],t,e,this)}),i)}async eachNeighborAsync(t,e,n,i=!1){const r=i?4:8;for(let i=0;i<r;++i){const r=X[i],s=t+r[0],o=e+r[1];this.hasXY(s,o)&&await n(this[s][o],s,o,this)}}forRect(t,e,n,i,r){T(t,e,n,i,((t,e)=>{this.hasXY(t,e)&&r(this[t][e],t,e,this)}))}randomEach(t){L.sequence(this.width*this.height).forEach((e=>{const n=e%this.width,i=Math.floor(e/this.width);t(this[n][i],n,i,this)}))}map(t){const e=new this.constructor(this.width,this.height);return e.copy(this),e.update(t),e}forCircle(t,e,n,i){S(t,e,n,((t,e)=>{this.hasXY(t,e)&&i(this[t][e],t,e,this)}))}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}isBoundaryXY(t,e){return this.hasXY(t,e)&&(0==t||t==this.width-1||0==e||e==this.height-1)}calcBounds(){const t={left:this.width,top:this.height,right:0,bottom:0};return this.forEach(((e,n,i)=>{e&&(t.left>n&&(t.left=n),t.right<n&&(t.right=n),t.top>i&&(t.top=i),t.bottom<i&&(t.bottom=i))})),t}update(t){T(this.width,this.height,((e,n)=>{this.hasXY(e,n)&&(this[e][n]=t(this[e][n],e,n,this))}))}updateRect(t,e,n,i,r){T(t,e,n,i,((t,e)=>{this.hasXY(t,e)&&(this[t][e]=r(this[t][e],t,e,this))}))}updateCircle(t,e,n,i){S(t,e,n,((t,e)=>{this.hasXY(t,e)&&(this[t][e]=i(this[t][e],t,e,this))}))}fill(t){const e="function"==typeof t?t:()=>t;this.update(e)}fillRect(t,e,n,i,r){const s="function"==typeof r?r:()=>r;this.updateRect(t,e,n,i,s)}fillCircle(t,e,n,i){const r="function"==typeof i?i:()=>i;this.updateCircle(t,e,n,r)}replace(t,e){this.update((n=>n==t?e:n))}copy(t){this.update(((e,n,i)=>t[n][i]))}count(t){const e="function"==typeof t?t:e=>e==t;let n=0;return this.forEach(((t,i,r)=>{e(t,i,r,this)&&++n})),n}dump(t){this.dumpRect(0,0,this.width,this.height,t)}dumpRect(t,e,n,i,r){let s,o;r=r||K,t=u(t,0,this.width-2),e=u(e,0,this.height-2);const h=u(t+n,1,this.width-1),a=u(e+i,1,this.height-1);let l=[];for(o=e;o<=a;o++){let e=(o+"]").padStart(3," ");for(s=t;s<=h;s++){s%10==0&&(e+=" ");e+=r(this[s][o],s,o)[0]}l.push(e)}console.log(l.join("\n"))}dumpAround(t,e,n){this.dumpRect(t-n,e-n,2*n,2*n)}closestMatchingLoc(t,e,n){let i=[-1,-1],r=100*(this.width+this.height);const s="function"==typeof n?n:t=>t==n;return this.forEach(((n,o,h)=>{if(s(n,o,h,this)){const n=Math.floor(100*d(t,e,o,h));n<r?(i[0]=o,i[1]=h,r=n):n==r&&L.chance(50)&&(i[0]=o,i[1]=h)}})),i}firstMatchingLoc(t){const e="function"==typeof t?t:e=>e==t;for(let t=0;t<this.width;++t)for(let n=0;n<this.height;++n)if(e(this[t][n],t,n,this))return[t,n];return[-1,-1]}randomMatchingLoc(t){const e="function"==typeof t?(e,n)=>t(this[e][n],e,n,this):(e,n)=>this.get(e,n)===t;return L.matchingXY(this.width,this.height,e)}matchingLocNear(t,e,n){const i="function"==typeof n?(t,e)=>n(this[t][e],t,e,this):(t,e)=>this.get(t,e)===n;return L.matchingXYNear(t,e,i)}arcCount(t,e,n){return C(t,e,((t,e)=>this.hasXY(t,e)&&n(this[t][e],t,e,this)))}}const V=[];class z extends j{constructor(t,e,n=0){super(t,e,n)}static alloc(...t){let e=t[0]||0,n=t[1]||0,i=t[2]||0;if(1==t.length&&(e=t[0].width,n=t[0].height,i=t[0].get.bind(t[0])),!e||!n)throw new Error("Grid alloc requires width and height parameters.");let r=V.pop();return r?(r._resize(e,n,i),r):new z(e,n,i)}static free(t){if(t){if(V.indexOf(t)>=0)return;V.push(t)}}_resize(t,e,n=0){const i="function"==typeof n?n:()=>n;for(;this.length<t;)this.push([]);this.length=t;let r=0,s=0;for(r=0;r<t;++r){const t=this[r];for(s=0;s<e;++s)t[s]=i(r,s);t.length=e}this._width=t,this._height=e,void 0!==this.x&&(this.x=void 0,this.y=void 0)}findReplaceRange(t,e,n){this.update((i=>i>=t&&i<=e?n:i))}floodFillRange(t,e,n=0,i=0,r=0){let s,o,h,u=1;if(r>=n&&r<=i)throw new Error("Invalid grid flood fill");const a=(t,e)=>this.hasXY(t,e)&&this[t][e]>=n&&this[t][e]<=i;if(!a(t,e))return 0;for(this[t][e]=r,s=0;s<4;s++)o=t+X[s][0],h=e+X[s][1],a(o,h)&&(u+=this.floodFillRange(o,h,n,i,r));return u}invert(){this.update((t=>t?0:1))}leastPositiveValue(){let t=Number.MAX_SAFE_INTEGER;return this.forEach((e=>{e>0&&e<t&&(t=e)})),t}randomLeastPositiveLoc(){const t=this.leastPositiveValue();return this.randomMatchingLoc(t)}valueBounds(t,e){let n,i,r=!1,s=this.width-1,o=0,h=this.height-1,u=0;for(n=0;n<this.width;n++){for(r=!1,i=0;i<this.height;i++)if(this[n][i]==t){r=!0;break}r&&(n<s&&(s=n),n>o&&(o=n))}for(i=0;i<this.height;i++){for(r=!1,n=0;n<this.width;n++)if(this[n][i]==t){r=!0;break}r&&(i<h&&(h=i),i>u&&(u=i))}return(e=e||new c(0,0,0,0)).x=s,e.y=h,e.width=o-s+1,e.height=u-h+1,e}floodFill(t,e,n,i){let r,s,o,h=1;const u="function"==typeof n?n:t=>t==n,a="function"==typeof i?i:()=>i;for(this[t][e]=a(this[t][e],t,e,this),r=0;r<4;r++)s=t+X[r][0],o=e+X[r][1],this.hasXY(s,o)&&u(this[s][o],s,o,this)&&(h+=this.floodFill(s,o,u,a));return h}}const q=z.alloc.bind(z),$=z.free.bind(z);function Z(t,e,n){return void 0===n?new z(t,e,0):"number"==typeof n?new z(t,e,n):new j(t,e,n)}k.grid=Z;var Q={__proto__:null,makeArray:G,Grid:j,NumGrid:z,alloc:q,free:$,make:Z,offsetZip:function(t,e,n,i,r){const s="function"==typeof r?r:(e,n,i,s)=>t[i][s]=r;e.forEach(((r,o,h)=>{const u=o+n,a=h+i;t.hasXY(u,a)&&r&&s(t[u][a],r,u,a,o,h,t,e)}))},intersection:function(t,e,n){n=n||t,t.update(((t,i,r)=>e[i][r]&&n[i][r]||0))},unite:function(t,e,n){n=n||t,t.update(((t,i,r)=>n[i][r]||e[i][r]))}},J={};let tt={};const et=[],nt="keypress",it="mousemove",rt="click",st="tick",ot="mouseup",ht=["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight"];async function ut(t,e){let n,i;return"function"==typeof(e=e||tt)?i=e:t.dir?i=e.dir:t.type===nt?i=e[t.key]||e[t.code]||e.keypress:e[t.type]&&(i=e[t.type]),i&&("function"==typeof i?n=await i.call(e,t):J[i]?n=await J[i](t):y("No command found: "+i)),"next"in e&&!1===e.next&&(n=!1),at(t),n}function at(t){et.push(t)}function lt(t){const e=et.pop()||{};return e.shiftKey=!1,e.ctrlKey=!1,e.altKey=!1,e.metaKey=!1,e.type=st,e.key=null,e.code=null,e.x=-1,e.y=-1,e.dir=null,e.dt=t,e}function ct(t){let e=t.key,n=t.code.toLowerCase();t.shiftKey&&(e=e.toUpperCase(),n=n.toUpperCase()),t.ctrlKey&&(e="^"+e,n="^"+n),t.metaKey&&(e="#"+e,n="#"+n),t.altKey&&(n="/"+n);const i=et.pop()||{};return i.shiftKey=t.shiftKey,i.ctrlKey=t.ctrlKey,i.altKey=t.altKey,i.metaKey=t.metaKey,i.type=nt,i.key=e,i.code=n,i.x=-1,i.y=-1,i.clientX=-1,i.clientY=-1,i.dir=ft(t.code),i.dt=0,i}function ft(t){const e=t.toLowerCase();return"arrowup"===e?[0,-1]:"arrowdown"===e?[0,1]:"arrowleft"===e?[-1,0]:"arrowright"===e?[1,0]:null}function dt(t){return ht.includes(t.code)}function gt(t,e,n){const i=et.pop()||{};return i.shiftKey=t.shiftKey,i.ctrlKey=t.ctrlKey,i.altKey=t.altKey,i.metaKey=t.metaKey,i.type=t.type,t.buttons&&"mouseup"!==t.type&&(i.type=rt),i.key=null,i.code=null,i.x=e,i.y=n,i.clientX=t.clientX,i.clientY=t.clientY,i.dir=null,i.dt=0,i}class _t{constructor(){this.running=!1,this.events=[],this.mouse={x:-1,y:-1},this.CURRENT_HANDLER=null,this.PAUSED=null,this.LAST_CLICK={x:-1,y:-1}}hasEvents(){return this.events.length}clearEvents(){for(;this.events.length;){const t=this.events.shift();et.push(t)}}pushEvent(t){if(this.PAUSED&&console.log("PAUSED EVENT",t.type),this.events.length){const e=this.events[this.events.length-1];if(e.type===t.type&&e.type===it)return e.x=t.x,e.y=t.y,void at(t)}if(t.type===rt){if(this.LAST_CLICK.x==t.x&&this.LAST_CLICK.y==t.y)return void at(t);this.LAST_CLICK.x=t.x,this.LAST_CLICK.y=t.y}else if(t.type==ot)return this.LAST_CLICK.x=-1,this.LAST_CLICK.y=-1,void at(t);if(this.CURRENT_HANDLER)this.CURRENT_HANDLER(t);else if(t.type===st){const e=this.events[0];if(e&&e.type===st)return e.dt+=t.dt,void at(t);this.events.unshift(t)}else this.events.push(t)}nextEvent(t,e){e=e||h;let n,i=0;for(;this.events.length;){const t=this.events.shift();if(t.type===it&&(this.mouse.x=t.x,this.mouse.y=t.y),e(t))return Promise.resolve(t);at(t)}return void 0===t&&(t=-1),0==t?Promise.resolve(null):(this.CURRENT_HANDLER?console.warn("OVERWRITE HANDLER - nextEvent"):this.events.length&&console.warn("SET HANDLER WITH QUEUED EVENTS - nextEvent"),this.CURRENT_HANDLER=r=>{if(r.type===it&&(this.mouse.x=r.x,this.mouse.y=r.y),r.type===st&&t>0){if(i+=r.dt,i<t)return}else if(!e(r))return;this.CURRENT_HANDLER=null,r.dt=i,n(r)},new Promise((t=>n=t)))}async run(t,e=-1){const n=setInterval((()=>{const t=lt(16);this.pushEvent(t)}),16);for(this.running=!0;this.running;){const n=await this.nextEvent(e);n&&await ut(n,t)&&(this.running=!1),t.draw&&"function"==typeof t.draw&&t.draw()}clearInterval(n)}stop(){this.running=!1}pauseEvents(){this.PAUSED||(this.PAUSED=this.CURRENT_HANDLER,this.CURRENT_HANDLER=null)}resumeEvents(){if(this.PAUSED&&(this.CURRENT_HANDLER&&console.warn("overwrite CURRENT HANDLER!"),this.CURRENT_HANDLER=this.PAUSED,this.PAUSED=null,this.events.length&&this.CURRENT_HANDLER)){const t=this.events.shift();this.CURRENT_HANDLER(t)}}async tickMs(t=1){let e;return setTimeout((()=>e()),t),new Promise((t=>e=t))}async nextKeyPress(t,e){return void 0===t&&(t=-1),e=e||h,this.nextEvent(t,(function(t){return t.type===nt&&e(t)}))}async nextKeyOrClick(t,e){return void 0===t&&(t=-1),e=e||h,this.nextEvent(t,(function(t){return(t.type===nt||t.type===rt)&&e(t)}))}async pause(t){const e=await this.nextKeyOrClick(t);return e&&e.type!==st}waitForAck(){return this.pause(3e5)}}function pt(){return new _t}k.loop=pt;const mt=pt();var Et={__proto__:null,commands:J,addCommand:function(t,e){J[t]=e},KEYPRESS:nt,MOUSEMOVE:it,CLICK:rt,TICK:st,MOUSEUP:ot,setKeymap:function(t){tt=t},dispatchEvent:ut,makeTickEvent:lt,makeKeyEvent:ct,keyCodeDirection:ft,ignoreKeyEvent:dt,onkeydown:function(t){if(dt(t))return;"Escape"===t.code&&mt.clearEvents();const e=ct(t);mt.pushEvent(e),t.preventDefault()},makeMouseEvent:gt,Loop:_t,make:pt,loop:mt};var yt={__proto__:null,FOV:class{constructor(t){this._startX=-1,this._startY=-1,this._maxRadius=100,this._isBlocked=t.isBlocked,this._calcRadius=t.calcRadius||g,this._setVisible=t.setVisible,this._hasXY=t.hasXY||h,this._debug=t.debug||o}calculate(t,e,n=10){this._setVisible(t,e,1),this._startX=t,this._startY=e,this._maxRadius=n+1;for(let t=4;t<8;++t){const e=r[t];this.castLight(1,1,0,0,e[0],e[1],0),this.castLight(1,1,0,e[0],0,0,e[1])}}castLight(t,e,n,i,r,s,o){if(t>=this._maxRadius)return void this._debug("CAST: row=%d, start=%d, end=%d, row >= maxRadius => cancel",t,e.toFixed(2),n.toFixed(2));if(e<n)return void this._debug("CAST: row=%d, start=%d, end=%d, start < end => cancel",t,e.toFixed(2),n.toFixed(2));this._debug("CAST: row=%d, start=%d, end=%d, x=%d,%d, y=%d,%d",t,e.toFixed(2),n.toFixed(2),i,r,s,o);let h,u,a,l,c,f=e,d=!1,g=-t,_=0;for(let p=-t;p<=0;p++){if(h=Math.floor(this._startX+p*i+g*r),u=Math.floor(this._startY+p*s+g*o),a=(p-.5)/(g+.5),l=(p+.5)/(g-.5),c=p/(g+.5),_=(p+.5)/g,!this._hasXY(h,u)){d=!0;continue}if(this._debug("- test %d,%d ... start=%d, min=%d, max=%d, end=%d, dx=%d, dy=%d",h,u,e.toFixed(2),c.toFixed(2),_.toFixed(2),n.toFixed(2),p,g),e<_){d=this._isBlocked(h,u);continue}if(n>c)break;const m=this._calcRadius(p,g);if(m<this._maxRadius){const t=1-m/this._maxRadius;this._setVisible(h,u,t),this._debug("       - visible")}if(d){if(this._isBlocked(h,u)){this._debug("       - blocked ... nextStart: %d",l.toFixed(2)),f=l;continue}d=!1}else this._isBlocked(h,u)&&t<this._maxRadius&&(this._debug("       - blocked ... start:%d, end:%d, nextStart: %d",f.toFixed(2),a.toFixed(2),l.toFixed(2)),d=!0,this.castLight(t+1,f,a,i,r,s,o),f=l)}d||this.castLight(t+1,f,n,i,r,s,o)}}};const bt=3e4;function wt(t){return{distance:0,cost:0,index:t,left:null,right:null}}function xt(t,e,n){return t.links[e+t.width*n]}const Rt=r;function vt(t,e,n){return e<=0||n<=0||(e>=t.length-1||n>=t[0].length-1)}function At(t,e){let n,i;for(function(t){let e,n,i,r=null,s=null,o=null;n=t.eightWays?8:4;let h=t.front.right;for(t.front.right=null;null!=h;){for(e=0;e<n;e++){if(i=h.index+(Rt[e][0]+t.width*Rt[e][1]),i<0||i>=t.width*t.height)continue;if(o=t.links[i],o.cost<0)continue;let n=0;if(e>=4){let i,r,s,o;if(n=.4142,r=h.index+Rt[e][0],r<0||r>=t.width*t.height)continue;if(o=h.index+t.width*Rt[e][1],o<0||o>=t.width*t.height)continue;if(i=t.links[r],s=t.links[o],-2==i.cost||-2==s.cost)continue}if(h.distance+o.cost+n<o.distance){for(o.distance=h.distance+o.cost+n,null!=o.right&&(o.right.left=o.left),null!=o.left&&(o.left.right=o.right),r=h,s=h.right;null!=s&&s.distance<o.distance;)r=s,s=s.right;null!=r&&(r.right=o),o.right=s,o.left=r,null!=s&&(s.left=o)}}s=h.right,h.left=null,h.right=null,h=s}}(t),n=0;n<t.width;n++)for(i=0;i<t.height;i++)e[n][i]=xt(t,n,i).distance}var St;function Tt(t,e,n,i,s=!1){let o,h,u,a,l,c;for(u=0,l=-1,a=0;a<(s?8:4);++a)o=e+r[a][0],h=n+r[a][1],c=i(o,h,e,n,t),!c&&t[e][n]-t[o][h]>u&&(l=a,u=t[e][n]-t[o][h]);return r[l]||null}var Ct={__proto__:null,FORBIDDEN:-1,OBSTRUCTION:-2,AVOIDED:10,NO_PATH:bt,calculateDistances:function(t,e,n,i,r=!1,s=3e4){const o=t.length,h=t[0].length;var u,a;let l,c;for(s<=0&&(s=bt),(!St||St.width<o||St.height<h)&&(u=o,a=h,St={eightWays:!1,front:wt(-1),links:G(u*a,(t=>wt(t))),width:u,height:a}),St.width=o,St.height=h,l=0;l<o;l++)for(c=0;c<h;c++)xt(St,l,c).cost=vt(i,l,c)?-2:i[l][c];!function(t,e,n){let i;for(t.eightWays=n,t.front.right=null,i=0;i<t.width*t.height;i++)t.links[i].distance=e,t.links[i].left=t.links[i].right=null}(St,s,r),function(t,e,n,i){let r,s,o;if(e>0&&n>0&&e<t.width-1&&n<t.height-1&&(o=xt(t,e,n),o.distance>i)){for(o.distance=i,null!=o.right&&(o.right.left=o.left),null!=o.left&&(o.left.right=o.right),r=t.front,s=t.front.right;null!=s&&s.distance<o.distance;)r=s,s=s.right;o.right=s,o.left=r,r.right=o,null!=s&&(s.left=o)}}(St,e,n,0),At(St,t)},nextStep:Tt,getPath:function(t,e,n,i){let r=e,s=n,o=0;if(t[r][s]<0||t[r][s]>=bt){const e=function(t,e,n){let i,r,s,o,h,u=-1,a=-1;const l=t.length,c=t[0].length;for(o=1e4,h=1e4,i=1;i<l-1;i++)for(r=1;r<c-1;r++)t[i][r]>=0&&t[i][r]<bt&&(s=(i-e)*(i-e)+(r-n)*(r-n),(s<o||s==o&&t[i][r]<h)&&(u=i,a=r,o=s,h=t[i][r]));return u>=0?[u,a]:null}(t,r,s);e&&(r=e[0],s=e[1])}const h=[[r,s]];let u;do{u=Tt(t,r,s,i,!0),u&&(r+=u[0],s+=u[1],h.push([r,s]),o++)}while(u);return o?h:null}};class Mt{constructor(t,e,n=!1){this.fn=t,this.context=e||null,this.once=n||!1,this.next=null}matches(t,e,n){return!(this.fn!==t||void 0!==n&&n!=this.once||e&&this.context!==e)}}var Nt={};function It(t,e,n,i=!1){if("function"!=typeof e)throw new TypeError("The listener must be a function");const r=new Mt(e,n||null,i);return x(Nt,t,r),r}function Lt(t,e,n,i=!1){if(!Nt[t])return!1;if(!e)return!1;let r=!1;return w(Nt[t],(s=>{s.matches(e,n,i)&&(R(Nt,t,s),r=!0)})),r}function Ot(t){Nt[t]&&(Nt[t]=null)}async function Dt(...t){const e=t[0];if(!Nt[e])return!1;let n=Nt[e];for(;n;){let i=n.next;n.once&&R(Nt,e,n),await n.fn.apply(n.context,t),n=i}return!0}var Ut={__proto__:null,Listener:Mt,addListener:It,on:function(t,e,n,i=!1){return It(t,e,n,i)},once:function(t,e,n){return It(t,e,n,!0)},removeListener:Lt,off:function(t,e,n,i=!1){return Lt(t,e,n,i)},clearEvent:Ot,removeAllListeners:function(t){t?Ot(t):Nt={}},emit:Dt};var kt={__proto__:null,make:function(t){if(void 0===t)return()=>100;if(null===t)return()=>0;if("number"==typeof t)return()=>t;if("function"==typeof t)return t;let e={};if("string"==typeof t){const n=t.split(/[,|]/).map((t=>t.trim()));e={},n.forEach((t=>{let[n,i]=t.split(":");e[n]=Number.parseInt(i)||100}))}else e=t;const n=Object.entries(e).map((([t,e])=>{if(e=Number.parseInt(e),t.includes("-")){let[n,i]=t.split("-").map((t=>t.trim())).map((t=>Number.parseInt(t)));return t=>t>=n&&t<=i?e:0}if(t.endsWith("+")){const n=Number.parseInt(t);return t=>t>=n?e:0}{const n=Number.parseInt(t);return t=>t===n?e:0}}));return 1==n.length?n[0]:t=>n.reduce(((e,n)=>e||n(t)),0)}};var Ft={__proto__:null,Scheduler:class{constructor(){this.next=null,this.time=0,this.cache=null}clear(){for(;this.next;){const t=this.next;this.next=t.next,t.next=this.cache,this.cache=t}}push(t,e=1){let n;if(this.cache?(n=this.cache,this.cache=n.next,n.next=null):n={fn:null,time:0,next:null},n.fn=t,n.time=this.time+e,this.next){let t=this,e=t.next;for(;e&&e.time<=n.time;)t=e,e=t.next;n.next=t.next,t.next=n}else this.next=n;return n}pop(){const t=this.next;return t?(this.next=t.next,t.next=this.cache,this.cache=t,this.time=Math.max(t.time,this.time),t.fn):null}remove(t){if(!t||!this.next)return;if(this.next===t)return void(this.next=t.next);let e=this.next,n=e.next;for(;n&&n!==t;)e=n,n=n.next;n===t&&(e.next=n.next)}}};const Pt="\n#version 300 es\nin uvec2 position;\nin uvec2 uv;\nin uint style;\nout vec2 fsUv;\nflat out uint fsStyle;\nuniform highp uvec2 tileSize;\nuniform uvec2 viewportSize;\nvoid main() {\n\tivec2 positionPx = ivec2(position * tileSize);\n\tvec2 positionNdc = (vec2(positionPx * 2) / vec2(viewportSize))-1.0;\n\tpositionNdc.y *= -1.0;\n\tgl_Position = vec4(positionNdc, 0.0, 1.0);\n\tfsUv = vec2(uv);\n\tfsStyle = style;\n}".trim(),Yt="\n#version 300 es\nprecision highp float;\nin vec2 fsUv;\nflat in uint fsStyle;\nout vec4 fragColor;\nuniform sampler2D font;\nuniform highp uvec2 tileSize;\nvoid main() {\n\tuvec2 fontTiles = uvec2(textureSize(font, 0)) / tileSize;\n\n\tuint glyph = (fsStyle & uint(0xFF000000)) >> 24;\n\tuint glyphX = (glyph & uint(0xF));\n\tuint glyphY = (glyph >> 4);\n\tuvec2 fontPosition = uvec2(glyphX, glyphY);\n\n\tuvec2 fontPx = (tileSize * fontPosition) + uvec2(vec2(tileSize) * fsUv);\n\tvec3 texel = texelFetch(font, ivec2(fontPx), 0).rgb;\n\n\tfloat s = 15.0;\n\tuint fr = (fsStyle & uint(0xF00)) >> 8;\n\tuint fg = (fsStyle & uint(0x0F0)) >> 4;\n\tuint fb = (fsStyle & uint(0x00F)) >> 0;\n\tvec3 fgRgb = vec3(fr, fg, fb) / s;\n  \n\tuint br = (fsStyle & uint(0xF00000)) >> 20;\n\tuint bg = (fsStyle & uint(0x0F0000)) >> 16;\n\tuint bb = (fsStyle & uint(0x00F000)) >> 12;\n\tvec3 bgRgb = vec3(br, bg, bb) / s;\n  \n\tfragColor = vec4(mix(bgRgb, fgRgb, texel), 1.0);\n}".trim();class Bt{constructor(t={}){this._tileWidth=12,this._tileHeight=16,this.needsUpdate=!0,this._map={},t.font=t.font||"monospace",this._node=document.createElement("canvas"),this._ctx=this.node.getContext("2d"),this._configure(t)}static fromImage(t){if("string"==typeof t){if(t.startsWith("data:"))throw new Error("Glyph: You must load a data string into an image element and use that.");const e=document.getElementById(t);if(!e)throw new Error("Glyph: Failed to find image element with id:"+t);t=e}const e=new this({tileWidth:t.width/16,tileHeight:t.height/16});return e._ctx.drawImage(t,0,0),e}static fromFont(t){"string"==typeof t&&(t={font:t});const e=new this(t),n=t.basicOnly||t.basic||!1;return e._initGlyphs(n),e}get node(){return this._node}get ctx(){return this._ctx}get tileWidth(){return this._tileWidth}get tileHeight(){return this._tileHeight}get pxWidth(){return this._node.width}get pxHeight(){return this._node.height}forChar(t){return t&&t.length&&this._map[t]||-1}_configure(t){this._tileWidth=t.tileWidth||this.tileWidth,this._tileHeight=t.tileHeight||this.tileHeight,this.node.width=16*this.tileWidth,this.node.height=16*this.tileHeight,this._ctx.fillStyle="black",this._ctx.fillRect(0,0,this.pxWidth,this.pxHeight);const e=t.fontSize||t.size||Math.max(this.tileWidth,this.tileHeight);this._ctx.font=e+"px "+t.font,this._ctx.textAlign="center",this._ctx.textBaseline="middle",this._ctx.fillStyle="white"}draw(t,e){if(t>256)throw new Error("Cannot draw more than 256 glyphs.");const n=t%16*this.tileWidth,i=Math.floor(t/16)*this.tileHeight,r=n+Math.floor(this.tileWidth/2),s=i+Math.floor(this.tileHeight/2);this._ctx.save(),this._ctx.beginPath(),this._ctx.rect(n,i,this.tileWidth,this.tileHeight),this._ctx.clip(),this._ctx.fillStyle="black",this._ctx.fillRect(n,i,this.tileWidth,this.tileHeight),this._ctx.fillStyle="white","function"==typeof e?e(this._ctx,n,i,this.tileWidth,this.tileHeight):(void 0===this._map[e]&&(this._map[e]=t),this._ctx.fillText(e,r,s)),this._ctx.restore(),this.needsUpdate=!0}_initGlyphs(t=!1){for(let t=32;t<127;++t)this.draw(t,String.fromCharCode(t));[" ","☺","☻","♥","♦","♣","♠","☼","☀","★","☆","♂","♀","♪","♫","☸","▶","◀","↕","‼","⁋","☯","⌘","☖","↑","↓","→","←","Ω","↔","▲","▼"].forEach(((t,e)=>{this.draw(e,t)})),t||["⌂","Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","¢","£","¥","₧","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","⌐","¬","½","¼","¡","«","»","░","▒","▓","│","┤","╡","╢","╖","╕","╣","║","╗","╝","╜","╛","┐","└","┴","┬","├","─","┼","╞","╟","╚","╔","╩","╦","╠","═","╬","╧","╨","╤","╥","╙","╘","╒","╓","╫","╪","┘","┌","█","▄","▌","▐","▀","α","ß","Γ","π","Σ","σ","µ","τ","Φ","Θ","Ω","δ","∞","φ","ε","∩","≡","±","≥","≤","⌠","⌡","÷","≈","°","∙","·","√","ⁿ","²","■"," "].forEach(((t,e)=>{this.draw(e+127,t)}))}}function Wt(t,e,n,i){return i?((t=Math.max(0,Math.min(255,Math.round(2.550001*t))))<<16)+((e=Math.max(0,Math.min(255,Math.round(2.550001*e))))<<8)+(n=Math.max(0,Math.min(255,Math.round(2.550001*n)))):((t=Math.max(0,Math.min(15,Math.round(t/100*15))))<<8)+((e=Math.max(0,Math.min(15,Math.round(e/100*15))))<<4)+(n=Math.max(0,Math.min(15,Math.round(n/100*15))))}const Ht={};class Xt extends Int16Array{constructor(t=-1,e=0,n=0,i=0,r=0,s=0,o=0,h=!1){super(7),this.dances=!1,this.set([t,e,n,i,r,s,o]),this.dances=h}get r(){return Math.round(2.550001*this[0])}get _r(){return this[0]}set _r(t){this[0]=t}get g(){return Math.round(2.550001*this[1])}get _g(){return this[1]}set _g(t){this[1]=t}get b(){return Math.round(2.550001*this[2])}get _b(){return this[2]}set _b(t){this[2]=t}get _rand(){return this[3]}get _redRand(){return this[4]}get _greenRand(){return this[5]}get _blueRand(){return this[6]}get l(){return Math.round(.5*(Math.min(this._r,this._g,this._b)+Math.max(this._r,this._g,this._b)))}get s(){return this.l>=100?0:Math.round((Math.max(this._r,this._g,this._b)-Math.min(this._r,this._g,this._b))*(100-Math.abs(2*this.l-100))/100)}get h(){let t=0,e=this.r,n=this.g,i=this.b;return t=e>=n&&n>=i?(n-i)/(e-i)*60:n>e&&e>=i?60*(2-(e-i)/(n-i)):n>=i&&i>e?60*(2+(i-e)/(n-e)):i>n&&n>e?60*(4-(n-e)/(i-e)):i>e&&e>=n?60*(4+(e-n)/(i-n)):60*(6-(i-n)/(e-n)),Math.round(t)}isNull(){return this._r<0}equals(t){if("string"==typeof t)return t.startsWith("#")?this.css(t.length>4)==t:this.name==t;if("number"==typeof t)return this.toInt()==t||this.toInt(!0)==t;const e=qt(t);return this.isNull()?e.isNull():this.every(((t,n)=>t==e[n]))}copy(t){Array.isArray(t)?8===t.length&&(this.dances=t[7]):(t=qt(t),this.dances=t.dances);for(let e=0;e<this.length;++e)this[e]=t[e]||0;return t instanceof Xt?this.name=t.name:this._changed(),this}_changed(){return this.name=void 0,this}clone(){const t=new this.constructor;return t.copy(this),t}assign(t=-1,e=0,n=0,i=0,r=0,s=0,o=0,h){for(let t=0;t<this.length;++t)this[t]=arguments[t]||0;return void 0!==h&&(this.dances=h),this._changed()}assignRGB(t=-1,e=0,n=0,i=0,r=0,s=0,o=0,h){for(let t=0;t<this.length;++t)this[t]=Math.round((arguments[t]||0)/2.55);return void 0!==h&&(this.dances=h),this._changed()}nullify(){return this[0]=-1,this.dances=!1,this._changed()}blackOut(){for(let t=0;t<this.length;++t)this[t]=0;return this.dances=!1,this._changed()}toInt(t=!1){if(this.isNull())return-1;if(!this.dances)return Wt(this._r,this._g,this._b,t);const e=O.number(this._rand),n=O.number(this._redRand),i=O.number(this._greenRand),r=O.number(this._blueRand);return Wt(this._r+e+n,this._g+e+i,this._b+e+r,t)}clamp(){return this.isNull()?this:(this._r=Math.min(100,Math.max(0,this._r)),this._g=Math.min(100,Math.max(0,this._g)),this._b=Math.min(100,Math.max(0,this._b)),this._changed())}mix(t,e){const n=qt(t);if(n.isNull())return this;this.isNull()&&this.blackOut();const i=100-(e=Math.min(100,Math.max(0,e)));for(let t=0;t<this.length;++t)this[t]=Math.round((this[t]*i+n[t]*e)/100);return this.dances=this.dances||n.dances,this._changed()}lighten(t){if(this.isNull())return this;if((t=Math.min(100,Math.max(0,t)))<=0)return;const e=100-t;for(let n=0;n<3;++n)this[n]=Math.round((this[n]*e+100*t)/100);return this._changed()}darken(t){if(this.isNull())return this;if((t=Math.min(100,Math.max(0,t)))<=0)return;const e=100-t;for(let n=0;n<3;++n)this[n]=Math.round((this[n]*e+0*t)/100);return this._changed()}bake(t=!1){if(this.isNull())return this;if(this.dances&&!t)return;this.dances=!1;const e=this;if(e[3]+e[4]+e[5]+e[6]){const t=O.number(this._rand),e=O.number(this._redRand),n=O.number(this._greenRand),i=O.number(this._blueRand);this._r+=t+e,this._g+=t+n,this._b+=t+i;for(let t=3;t<this.length;++t)this[t]=0;return this._changed()}return this}add(t,e=100){const n=qt(t);if(n.isNull())return this;this.isNull()&&this.blackOut();for(let t=0;t<this.length;++t)this[t]+=Math.round(n[t]*e/100);return this.dances=this.dances||n.dances,this._changed()}scale(t){if(this.isNull()||100==t)return this;t=Math.max(0,t);for(let e=0;e<this.length;++e)this[e]=Math.round(this[e]*t/100);return this._changed()}multiply(t){if(this.isNull())return this;let e=t;if(!Array.isArray(t)){if(t.isNull())return this;e=t}const n=Math.max(3,Math.min(this.length,e.length));for(let t=0;t<n;++t)this[t]=Math.round(this[t]*(e[t]||0)/100);return this._changed()}normalize(){if(this.isNull())return this;const t=Math.max(this._r,this._g,this._b);return t<=100?this:(this._r=Math.round(100*this._r/t),this._g=Math.round(100*this._g/t),this._b=Math.round(100*this._b/t),this._changed())}css(t=!1){return"#"+this.toInt(t).toString(16).padStart(t?6:3,"0")}toString(t=!1){return this.name?this.name:this.isNull()?"null color":this.css(t)}}function Gt(t,e=!1){for(;t.length<3;)t.push(0);if(e)for(let e=0;e<7;++e)t[e]=Math.round(100*(t[e]||0)/255);return new Xt(...t)}function Kt(t){if(!t.startsWith("#"))throw new Error('Color CSS strings must be of form "#abc" or "#abcdef" - received: ['+t+"]");const e=Number.parseInt(t.substring(1),16);let n,i,r;return 4==t.length?(n=Math.round((e>>8)/15*100),i=Math.round(((240&e)>>4)/15*100),r=Math.round((15&e)/15*100)):(n=Math.round((e>>16)/255*100),i=Math.round(((65280&e)>>8)/255*100),r=Math.round((255&e)/255*100)),new Xt(n,i,r)}function jt(t){const e=Ht[t];if(!e)throw new Error("Unknown color name: "+t);return e}function Vt(t,e=!1){const n=new Xt;for(let t=0;t<n.length;++t)n[t]=0;return t<0?n.assign(-1):e||t>4095?n.assign(Math.round(100*((16711680&t)>>16)/255),Math.round(100*((65280&t)>>8)/255),Math.round(100*(255&t)/255)):n.assign(Math.round(100*((3840&t)>>8)/15),Math.round(100*((240&t)>>4)/15),Math.round(100*(15&t)/15)),n}function zt(...t){let e=t[0],n=t[1];if(0==t.length)return new Xt;if(t.length>2&&(e=t,n=!1),null==e)return new Xt(-1);if(e instanceof Xt)return e.clone();if("string"==typeof e)return e.startsWith("#")?Kt(e):jt(e).clone();if(Array.isArray(e))return Gt(e,n);if("number"==typeof e)return Vt(e,n);throw new Error("Failed to make color - unknown argument: "+JSON.stringify(e))}function qt(...t){const e=t[0];return e instanceof Xt?e:void 0===e?new Xt(-1):"string"!=typeof e||e.startsWith("#")?zt(e,t[1]):jt(e)}function $t(t,e){if(t.isNull()||e.isNull())return;const n=t.clone().clamp(),i=e.clone().clamp();let r=Math.abs(n.h-i.h);if(r>180&&(r=360-r),r>45)return;if(Math.abs(n.l-i.l)>=40)return;const[s,o]=[n,i].sort(((t,e)=>t.s-e.s));for(;o.l-s.l<40;)o.mix(ee,5),s.mix(te,5);t.copy(n),e.copy(i)}function Zt(t,...e){let n=e;1==e.length&&(n=e[0]);const i=n instanceof Xt?n:zt(n);return Ht[t]=i,i.name=t,i}function Qt(t,...e){let n;return n=1==e.length?Zt(t,e[0]):Zt(t,...e),Zt("light_"+t,n.clone().lighten(25)),Zt("lighter_"+t,n.clone().lighten(50)),Zt("lightest_"+t,n.clone().lighten(75)),Zt("dark_"+t,n.clone().darken(25)),Zt("darker_"+t,n.clone().darken(50)),Zt("darkest_"+t,n.clone().darken(75)),n}k.color=zt;const Jt=Zt("NONE",-1),te=Zt("black",0),ee=Zt("white",4095);Qt("teal",[30,100,100]),Qt("brown",[60,40,0]),Qt("tan",[80,70,55]),Qt("pink",[100,60,66]),Qt("gray",[50,50,50]),Qt("yellow",[100,100,0]),Qt("purple",[100,0,100]),Qt("green",[0,100,0]),Qt("orange",[100,50,0]),Qt("blue",[0,0,100]),Qt("red",[100,0,0]),Qt("amber",[100,75,0]),Qt("flame",[100,25,0]),Qt("fuchsia",[100,0,100]),Qt("magenta",[100,0,75]),Qt("crimson",[100,0,25]),Qt("lime",[75,100,0]),Qt("chartreuse",[50,100,0]),Qt("sepia",[50,40,25]),Qt("violet",[50,0,100]),Qt("han",[25,0,100]),Qt("cyan",[0,100,100]),Qt("turquoise",[0,100,75]),Qt("sea",[0,100,50]),Qt("sky",[0,75,100]),Qt("azure",[0,50,100]),Qt("silver",[75,75,75]),Qt("gold",[100,85,0]);var ne={__proto__:null,colors:Ht,Color:Xt,fromArray:Gt,fromCss:Kt,fromName:jt,fromNumber:Vt,make:zt,from:qt,separate:$t,swap:function(t,e){const n=t.clone();t.copy(e),e.copy(n)},relativeLuminance:function(t,e){return Math.round(100*((t.r-e.r)*(t.r-e.r)*.2126+(t.g-e.g)*(t.g-e.g)*.7152+(t.b-e.b)*(t.b-e.b)*.0722)/65025)},distance:function(t,e){return Math.round(100*((t.r-e.r)*(t.r-e.r)*.3333+(t.g-e.g)*(t.g-e.g)*.3333+(t.b-e.b)*(t.b-e.b)*.3333)/65025)},install:Zt,installSpread:Qt,NONE:Jt};class ie{constructor(t){this.ch=b(null==t?void 0:t.ch,-1),this.fg=qt(null==t?void 0:t.fg),this.bg=qt(null==t?void 0:t.bg)}_changed(){return this}copy(t){return this.ch=t.ch,this.fg.copy(t.fg),this.bg.copy(t.bg),this._changed()}clone(){const t=new ie;return t.copy(this),t}equals(t){return this.ch==t.ch&&this.fg.equals(t.fg)&&this.bg.equals(t.bg)}get dances(){return this.fg.dances||this.bg.dances}nullify(){return this.ch=-1,this.fg.nullify(),this.bg.nullify(),this._changed()}blackOut(){return this.ch=0,this.fg.blackOut(),this.bg.blackOut(),this._changed()}draw(t=-1,e=-1,n=-1){return t&&-1!==t&&(this.ch=t),-1!==e&&null!==e&&(e=qt(e),this.fg.copy(e)),-1!==n&&null!==n&&(n=qt(n),this.bg.copy(n)),this._changed()}drawSprite(t,e){return t===this?this:(void 0===e&&(e=t.opacity),void 0===e&&(e=100),e<=0?void 0:(t.ch&&(this.ch=t.ch),(t.fg&&-1!==t.fg||0===t.fg)&&this.fg.mix(t.fg,e),(t.bg&&-1!==t.bg||0===t.bg)&&this.bg.mix(t.bg,e),this._changed()))}invert(){return[this.bg,this.fg]=[this.fg,this.bg],this._changed()}multiply(t,e=!0,n=!0){return t=qt(t),e&&this.fg.multiply(t),n&&this.bg.multiply(t),this._changed()}mix(t,e=50,n=e){return t=qt(t),e>0&&this.fg.mix(t,e),n>0&&this.bg.mix(t,n),this._changed()}add(t,e=100,n=e){return t=qt(t),e>0&&this.fg.add(t,e),n>0&&this.bg.add(t,n),this._changed()}separate(){return $t(this.fg,this.bg),this._changed()}bake(t=!1){return this.fg.bake(t),this.bg.bake(t),this._changed(),{ch:this.ch,fg:this.fg.toInt(),bg:this.bg.toInt()}}toString(){return`{ ch: ${this.ch}, fg: ${this.fg.toString(!0)}, bg: ${this.bg.toString(!0)} }`}}k.mixer=function(t){return new ie(t)};var re={colorStart:"Ω",colorEnd:"∆",field:"§",defaultFg:null,defaultBg:null},se={eachColor:()=>{},default:(t,e,n)=>void 0!==n?`${n}.!!${t}!!`:`!!${t}!!`};function oe(t){const e=re.field,n=t.split(e).map(((t,n)=>n%2==0?ue(t):0==t.length?ue(e):function(t){const e=/((\w+) )?(\w+)(\.(\w+))?(%[\+\.\-\d]*[dsf])?/.exec(t)||[],n=e[2],i=e[3],r=e[5],s=e[6];let o=(h=i,function(t){const e=se[h];if(e)return e(h,t);const n=t[h];return void 0!==n?n:se.default(h,t)});var h;r&&r.length&&(o=function(t,e){return function(n){const i=e(n);if(!i)return se.default(t,n,i);const r=i[t];return void 0===r?se.default(t,n,i):r}}(r,o));n&&n.length&&(o=function(t,e){const n=se[t]||se.default;return function(i){const r=e(i);return n(t,i,r)}}(n,o));s&&s.length&&(o=s.endsWith("s")?function(t,e){const n=/%(-?\d*)s/.exec(t)||[],i=Number.parseInt(n[1]||"0");return function(t){let n=""+e(t);return i<0?n=n.padEnd(-i):i&&(n=n.padStart(i)),n}}(s,o):s.endsWith("d")?function(t,e){const n=/%([\+-]*)(\d*)d/.exec(t)||["","","0"];let i=Number.parseInt(n[2]||"0");const r=n[1].includes("+"),s=n[1].includes("-");return function(t){const n=Number.parseInt(e(t)||0);let o=""+n;return n>0&&r&&(o="+"+o),i&&s?o.padEnd(i):i?o.padStart(i):o}}(s,o):function(t,e){const n=/%([\+-]*)(\d*)(\.(\d+))?f/.exec(t)||["","","0"];let i=Number.parseInt(n[2]||"0");const r=n[1].includes("+"),s=n[1].includes("-"),o=Number.parseInt(n[4])||0;return function(t){const n=Number.parseFloat(e(t)||0);let h;return h=o?n.toFixed(o):""+n,n>0&&r&&(h="+"+h),i&&s?h.padEnd(i):i?h.padStart(i):h}}(s,o));return o}(t)));return function(t={}){return n.map((e=>e(t))).join("")}}function he(t,e={}){return oe(t)(e)}function ue(t){return()=>t}function ae(t,e,n,i){if(null==t)return;if(!e)return;if(!(t=""+t).length)return;const r=[],s=se.eachColor;void 0===n&&(n=re.defaultFg),void 0===i&&(i=re.defaultBg);const o={fg:n,bg:i},h=re.colorStart,u=re.colorEnd;s(o);let a=0;for(let l=0;l<t.length;++l){const c=t[l];if(c==h){let e=l+1;for(;e<t.length&&t[e]!=h;)++e;if(e==t.length)return void console.warn(`Reached end of string while seeking end of color start section.\n- text: ${t}\n- start @: ${l}`);if(e!=l+1){r.push([o.fg,o.bg]);const n=t.substring(l+1,e).split("|");o.fg=n[0]||o.fg,o.bg=n[1]||o.bg,s(o),l=e;continue}++l}else if(c==u){if(t[l+1]!=u){const t=r.pop();[o.fg,o.bg]=t||[n,i];continue}++l}e(c,o.fg,o.bg,a,l),++a}}function le(t){if(!t||0==t.length)return 0;let e=0;const n=re.colorStart,i=re.colorEnd;for(let r=0;r<t.length;++r){const s=t[r];if(s==n){r=t.indexOf(n,r+1)}else s==i||++e}return e}function ce(t){const e=re.colorStart,n=re.colorEnd;let i=0;for(;i<t.length;){const r=t[i];if(r==e){for(++i;t[i]!=e&&i<t.length;)++i;++i}else if(r==n)for(++i;t[i]==n&&i<t.length;)++i;else{if(/[A-Za-z]/.test(r))return t.substring(0,i)+r.toUpperCase()+t.substring(i+1);++i}}return t}function fe(t,e){const n=re.colorStart,i=re.colorEnd;let r=e,s=0,o=!0;for(;r<t.length;){const e=t[r];if(" "==e){for(;" "==t[r+1];)++r,++s;return[r,s]}if("-"==e)return[r,s];if("\n"==e)return[r,s];if(e!=n)e!=i?(s+=o?1:0,++r):(t[r+1]==i&&(s+=1,++r),r++);else{if(t[r+1]==n&&o){s+=1,r+=2;continue}o=!o,++r}}return[r,s]}function de(t,e,n,i=""){return t.substring(0,e)+i+t.substring(e+n)}function ge(t,e,n,i,r,s){if(s>=r)return[t,i];if(r+1>2*e)throw new Error("Cannot hyphenate - word length > 2 * width");if(s<4&&r<=e)return[t=de(t,n-1,1,"\n"),i+1];s+e<=r&&(t=de(t,n-1,1,"\n"),s=e);return[t=de(t,function(t,e,n){const i=re.colorStart,r=re.colorEnd;let s=e;for(;n>0;){const e=t[s];if(e===i){if(++s,t[s]===i)--n;else for(;t[s]!==i;)++s;++s}else e===r?(t[s+1]===r&&(--n,++s),++s):(--n,++s)}return s}(t,n,Math.min(Math.floor(r/2),s-1)),0,"-\n"),i+2]}function _e(t,e,n=0){if(!e)throw new Error("Need string and width");if(t.length<e)return t;if(le(t)<e)return t;if(-1==t.indexOf("\n"))return pe(t,e,n);return t.split("\n").map(((t,i)=>pe(t,e,i?n:0))).join("\n")}function pe(t,e,n){if(t.length<e)return t;if(le(t)<e)return t;let i=e;e-=n;let r=t,s=!0,o=-1;for(;o<r.length;){let[t,n]=fe(r,o+(s?1:0)),h=!1;if("-"==r[t]&&(t++,n++,h=!0),n>e)[r,t]=ge(r,e,o+1,t,n,i);else if(n==i){const n=h?0:1;r=de(r,t,n,t<r.length?"\n":""),t+=1-n,i=e}else if(n>i){const u=s?1:0;r=de(r,o,u,"\n"),t+=1-u;i=e-n-(h?0:1)}else{i-=n+(h?0:1)}s=!h,o=t}return r}function me(t,e,n=0){const i=re.colorStart,r=[];let s=_e(t,e,n),o=0,h=null,u=null;ae(s,((t,e,n,a,l)=>{if("\n"==t){let t=h||u?`${i}${h||""}${u?"|"+u:""}${i}`:"";r.push(t+s.substring(o,l)),o=l+1,h=e,u=n}}));let a=h||u?`${i}${h||""}${u?"|"+u:""}${i}`:"";return r.push(a+s.substring(o)),r}var Ee={__proto__:null,compile:oe,apply:he,eachChar:ae,length:le,padStart:function(t,e,n=" "){const i=t.length-le(t);return t.padStart(e+i,n)},padEnd:function(t,e,n=" "){const i=t.length-le(t);return t.padEnd(e+i,n)},center:function(t,e,n=" "){const i=t.length,r=e-le(t);if(r<=0)return t;const s=Math.floor(r/2);return t.padStart(i+s,n).padEnd(i+r,n)},firstChar:function(t){const e=re.colorStart,n=re.colorEnd;let i=0;for(;i<t.length;){const r=t[i];if(r===e){if(t[i+1]===e)return e;for(++i;t[i]!==e;)++i;++i}else{if(r!==n)return r;if(t[i+1]===n)return n;++i}}return null},capitalize:ce,removeColors:function(t){const e=re.colorStart,n=re.colorEnd;let i="",r=0;for(let s=0;s<t.length;++s){const o=t[s];if(o===e){if(t[s+1]==e){++s;continue}for(i+=t.substring(r,s),++s;t[s]!=e&&s<t.length;)++s;r=s+1}else if(o===n){if(t[s+1]==n){++s;continue}i+=t.substring(r,s),r=s+1}}return 0==r?t:(i+=t.substring(r),i)},wordWrap:_e,splitIntoLines:me,configure:function(t={}){void 0!==t.fg&&(re.defaultFg=t.fg),void 0!==t.bg&&(re.defaultBg=t.bg),t.colorStart&&(re.colorStart=t.colorStart),t.colorEnd&&(re.colorEnd=t.colorEnd),t.field&&(re.field=t.field)},addHelper:function(t,e){se[t]=e},options:re};class ye{constructor(t,e){this._width=t,this._height=e,this._data=new Uint32Array(t*e)}get width(){return this._width}get height(){return this._height}resize(t,e){const n=this._data;this._width=t,this._height=e,n.length<t*e?(this._data=new Uint32Array(t*e),this._data.set(n,0)):this._data=n.slice(t*e)}get(t,e){let n=e*this.width+t;const i=this._data[n]||0;return{glyph:i>>24,fg:4095&i,bg:i>>12&4095}}toGlyph(t){return"number"==typeof t?t:t&&t.length?t.charCodeAt(0):-1}draw(t,e,n=-1,i=-1,r=-1){let s=e*this.width+t;const o=this._data[s]||0;"number"!=typeof n&&(n=this.toGlyph(n)),"number"!=typeof i&&(i=qt(i).toInt()),"number"!=typeof r&&(r=qt(r).toInt());const h=((n=n>=0?255&n:o>>24)<<24)+((r=r>=0?4095&r:o>>12&4095)<<12)+(i=i>=0?4095&i:4095&o);return this._data[s]=h,this}drawSprite(t,e,n){const i=null===n.ch?-1:n.ch,r=null===n.fg?-1:n.fg,s=null===n.bg?-1:n.bg;return this.draw(t,e,i,r,s)}blackOut(...t){return 0==t.length?this.fill(0,0,0):this.draw(t[0],t[1],0,0,0)}fill(t=0,e=4095,n=0){"string"==typeof t&&(t=this.toGlyph(t));const i=((t&=255)<<24)+((n&=4095)<<12)+(e&=4095);return this._data.fill(i),this}copy(t){return this._data.set(t._data),this}drawText(t,e,n,i=4095,r=-1){return"number"!=typeof i&&(i=qt(i)),"number"!=typeof r&&(r=qt(r)),ae(n,((n,i,r,s)=>{t+s>=this.width||this.draw(s+t,e,n,i,r)}),i,r),++e}wrapText(t,e,n,i,r=4095,s=-1,o=0){"number"!=typeof r&&(r=qt(r)),"number"!=typeof s&&(s=qt(s)),i=_e(i,n=Math.min(n,this.width-t),o);let h=t;for(ae(i,((i,r,s)=>{if("\n"==i){for(;h<t+n;)this.draw(h++,e,0,0,s);return++e,void(h=t+o)}this.draw(h++,e,i,r,s)}),r,s);h<t+n;)this.draw(h++,e,0,0,s);return++e}fillRect(t,e,n,i,r=-1,s=-1,o=-1){null===r&&(r=-1),"number"!=typeof r&&(r=this.toGlyph(r)),"number"!=typeof s&&(s=qt(s).toInt()),"number"!=typeof o&&(o=qt(o).toInt());for(let h=t;h<t+n;++h)for(let t=e;t<e+i;++t)this.draw(h,t,r,s,o);return this}blackOutRect(t,e,n,i,r=0){return"number"!=typeof r&&(r=qt(r)),this.fillRect(t,e,n,i,0,0,r)}highlight(t,e,n,i){"number"!=typeof n&&(n=qt(n));const r=new ie,s=this.get(t,e);return r.drawSprite(s),r.fg.add(n,i),r.bg.add(n,i),this.drawSprite(t,e,r),this}mix(t,e){"number"!=typeof t&&(t=qt(t));const n=new ie;for(let i=0;i<this.width;++i)for(let r=0;r<this.height;++r){const s=this.get(i,r);n.drawSprite(s),n.fg.mix(t,e),n.bg.mix(t,e),this.drawSprite(i,r,n)}return this}dump(){const t=[];let e="    ";for(let t=0;t<this.width;++t)t%10==0&&(e+=" "),e+=t%10;t.push(e),t.push("");for(let e=0;e<this.height;++e){let n=`${(""+e).padStart(2)}] `;for(let t=0;t<this.width;++t){t%10==0&&(n+=" ");const i=this.get(t,e).glyph;n+=String.fromCharCode(i||32)}t.push(n)}console.log(t.join("\n"))}}k.dataBuffer=function(t,e){return new ye(t,e)};class be extends ye{constructor(t){super(t.width,t.height),this._target=t,t.copyTo(this._data)}toGlyph(t){return this._target.toGlyph(t)}render(){return this._target.copy(this._data),this}load(){return this._target.copyTo(this._data),this}}class we extends Error{constructor(...t){super(...t),Error.captureStackTrace&&Error.captureStackTrace(this,we),this.name="NotSupportedError"}}class xe{constructor(t,e,n){this.mouse={x:-1,y:-1},this._renderRequested=!1,this._width=50,this._height=25,this._node=this._createNode(),this._createContext(),this._configure(t,e,n),this._buffer=new be(this)}get node(){return this._node}get width(){return this._width}get height(){return this._height}get tileWidth(){return this._glyphs.tileWidth}get tileHeight(){return this._glyphs.tileHeight}get pxWidth(){return this.node.clientWidth}get pxHeight(){return this.node.clientHeight}get glyphs(){return this._glyphs}set glyphs(t){this._setGlyphs(t)}toGlyph(t){return"number"==typeof t?t:this._glyphs.forChar(t)}get buffer(){return this._buffer}_createNode(){return document.createElement("canvas")}_configure(t,e,n){this._width=t,this._height=e,this._setGlyphs(n)}_setGlyphs(t){return t!==this._glyphs&&(this._glyphs=t,this.resize(this._width,this._height),!0)}resize(t,e){this._width=t,this._height=e,this._buffer&&this._buffer.resize(t,e);const n=this.node;n.width=this._width*this.tileWidth,n.height=this._height*this.tileHeight}_requestRender(){this._renderRequested||(this._renderRequested=!0,requestAnimationFrame((()=>this.render())))}copy(t){this._data.set(t),this._requestRender()}copyTo(t){t.set(this._data)}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}set onclick(t){this.node.onclick=t?e=>{const n=gt(e,this._toX(e.offsetX),this._toY(e.offsetY));t(n)}:null}set onmousemove(t){this.node.onmousemove=t?e=>{const n=this._toX(e.offsetX),i=this._toY(e.offsetY);if(n==this.mouse.x&&i==this.mouse.y)return;this.mouse.x=n,this.mouse.y=i;const r=gt(e,n,i);t(r)}:null}set onmouseup(t){t?this.node.onmouseup=e=>{const n=gt(e,this._toX(e.offsetX),this._toY(e.offsetY));t(n)}:this.node.onmousemove=null}_toX(t){return u(Math.floor(this.width*(t/this.node.clientWidth)),0,this.width-1)}_toY(t){return u(Math.floor(this.height*(t/this.node.clientHeight)),0,this.height-1)}}class Re extends xe{constructor(t,e,n){super(t,e,n)}_createContext(){let t=this.node.getContext("webgl2");if(!t)throw new we("WebGL 2 not supported");this._gl=t,this._buffers={},this._attribs={},this._uniforms={};const e=function(t,...e){const n=t.createProgram();if([t.VERTEX_SHADER,t.FRAGMENT_SHADER].forEach(((i,r)=>{const s=t.createShader(i);if(t.shaderSource(s,e[r]),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(s));t.attachShader(n,s)})),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(n));return n}(t,Pt,Yt);t.useProgram(e);const n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let i=0;i<n;i++){t.enableVertexAttribArray(i);let n=t.getActiveAttrib(e,i);this._attribs[n.name]=i}const i=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let n=0;n<i;n++){let i=t.getActiveUniform(e,n);this._uniforms[i.name]=t.getUniformLocation(e,i.name)}t.uniform1i(this._uniforms.font,0),this._texture=function(t){let e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),e}(t)}_createGeometry(){const t=this._gl;this._buffers.position&&t.deleteBuffer(this._buffers.position),this._buffers.uv&&t.deleteBuffer(this._buffers.uv);let e=function(t,e,n,i){let r=n*i,s=new Uint16Array(r*Ae.length),o=new Uint8Array(r*Ae.length),h=0;for(let t=0;t<i;t++)for(let e=0;e<n;e++)Ae.forEach((n=>{s[h]=(h%2?t:e)+n,o[h]=n,h++}));const u=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,u),t.vertexAttribIPointer(e.position,2,t.UNSIGNED_SHORT,0,0),t.bufferData(t.ARRAY_BUFFER,s,t.STATIC_DRAW);const a=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,a),t.vertexAttribIPointer(e.uv,2,t.UNSIGNED_BYTE,0,0),t.bufferData(t.ARRAY_BUFFER,o,t.STATIC_DRAW),{position:u,uv:a}}(t,this._attribs,this.width,this.height);Object.assign(this._buffers,e)}_createData(){const t=this._gl,e=this._attribs,n=this.width*this.height;this._buffers.style&&t.deleteBuffer(this._buffers.style),this._data=new Uint32Array(6*n);const i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.vertexAttribIPointer(e.style,1,t.UNSIGNED_INT,0,0),Object.assign(this._buffers,{style:i})}_setGlyphs(t){if(!super._setGlyphs(t))return!1;const e=this._gl,n=this._uniforms;return e.uniform2uiv(n.tileSize,[this.tileWidth,this.tileHeight]),this._uploadGlyphs(),!0}_uploadGlyphs(){if(!this._glyphs.needsUpdate)return;const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._glyphs.node),this._requestRender(),this._glyphs.needsUpdate=!1}resize(t,e){super.resize(t,e);const n=this._gl,i=this._uniforms;n.viewport(0,0,this.node.width,this.node.height),n.uniform2ui(i.viewportSize,this.node.width,this.node.height),this._createGeometry(),this._createData()}copy(t){t.forEach(((t,e)=>{const n=6*e;this._data[n+2]=t,this._data[n+5]=t})),this._requestRender()}copyTo(t){const e=this.width*this.height;for(let n=0;n<e;++n){const e=6*n;t[n]=this._data[e+2]}}render(){const t=this._gl;if(this._glyphs.needsUpdate)this._uploadGlyphs();else if(!this._renderRequested)return;this._renderRequested=!1,t.bindBuffer(t.ARRAY_BUFFER,this._buffers.style),t.bufferData(t.ARRAY_BUFFER,this._data,t.DYNAMIC_DRAW),t.drawArrays(t.TRIANGLES,0,this._width*this._height*6)}}class ve extends xe{constructor(t,e,n){super(t,e,n)}_createContext(){const t=this.node.getContext("2d");if(!t)throw new we("2d context not supported!");this._ctx=t}resize(t,e){super.resize(t,e),this._data=new Uint32Array(t*e),this._changed=new Int8Array(t*e)}copy(t){for(let e=0;e<this._data.length;++e)this._data[e]!==t[e]&&(this._data[e]=t[e],this._changed[e]=1);this._requestRender()}render(){this._renderRequested=!1;for(let t=0;t<this._changed.length;++t)this._changed[t]&&this._renderCell(t),this._changed[t]=0}_renderCell(t){const e=t%this.width,n=Math.floor(t/this.width),i=this._data[t],r=i/(1<<24)>>0,s=i>>12&4095,o=4095&i,h=e*this.tileWidth,u=n*this.tileHeight,a=r%16*this.tileWidth,l=Math.floor(r/16)*this.tileHeight,c=this.glyphs.ctx.getImageData(a,l,this.tileWidth,this.tileHeight);for(let t=0;t<c.width*c.height;++t){const e=c.data[4*t]/255,n=1-e;c.data[4*t+0]=e*(17*((3840&o)>>8))+n*(17*((3840&s)>>8)),c.data[4*t+1]=e*(17*((240&o)>>4))+n*(17*((240&s)>>4)),c.data[4*t+2]=e*(17*(15&o))+n*(17*(15&s)),c.data[4*t+3]=255}this._ctx.putImageData(c,h,u)}}const Ae=[0,0,1,0,0,1,0,1,1,0,1,1];var Se={__proto__:null,NotSupportedError:we,BaseCanvas:xe,Canvas:Re,Canvas2D:ve,make:function(...t){let e,n,i=t[0],r=t[1],s=t[2];1==t.length&&(s=t[0],r=s.height||34,i=s.width||80),s=s||{font:"monospace"},e=s.image?Bt.fromImage(s.image):Bt.fromFont(s);try{n=new Re(i,r,e)}catch(t){if(!(t instanceof we))throw t}if(n||(n=new ve(i,r,e)),s.div){let t;"string"==typeof s.div?(t=document.getElementById(s.div),t||console.warn("Failed to find parent element by ID: "+s.div)):t=s.div,t&&t.appendChild&&t.appendChild(n.node)}if(s.io||s.loop){let t=s.loop||mt;n.onclick=e=>t.pushEvent(e),n.onmousemove=e=>t.pushEvent(e),n.onmouseup=e=>t.pushEvent(e)}return n},Glyphs:Bt,DataBuffer:ye,Buffer:be,makeBuffer:function(...t){return 1==t.length?new be(t[0]):new ye(t[0],t[1])}};class Te{constructor(t,e,n,i=100){t||(t=null),this.ch=t,this.fg=qt(e),this.bg=qt(n),this.opacity=i>=0?i:100}clone(){return new Te(this.ch,this.fg,this.bg,this.opacity)}}const Ce={};function Me(...t){let e,n=null,i=-1,r=-1;if(0==t.length)return new Te(null,-1,-1);if(1==t.length&&Array.isArray(t[0])&&(t=t[0]),t.length>3?(e=t[3],t.pop()):2==t.length&&"number"==typeof t[1]&&t[0].length>1&&(e=t.pop()),t.length>1)n=t[0]||null,i=t[1],r=t[2];else if("string"==typeof t[0]&&1==t[0].length)n=t[0],i="white";else if("string"==typeof t[0]&&t[0].length>1||"number"==typeof t[0])r=t[0];else if(t[0]instanceof Xt)r=t[0];else{const s=t[0];n=s.ch||null,i=s.fg||-1,r=s.bg||-1,e=s.opacity}return"string"==typeof i?i=qt(i):Array.isArray(i)?i=zt(i):null==i&&(i=-1),"string"==typeof r?r=qt(r):Array.isArray(r)?r=zt(r):null==r&&(r=-1),new Te(n,i,r,e)}k.sprite=Me;var Ne={__proto__:null,Sprite:Te,sprites:Ce,make:Me,from:function(...t){if(1==t.length&&"string"==typeof t[0]){const e=Ce[t[0]];if(!e)throw new Error("Failed to find sprite: "+t[0]);return e}return Me(t)},install:function(t,...e){let n;return n=Me(...e),n.name=t,Ce[t]=n,n},Mixer:ie};const Ie={};function Le(t,e){const n=oe(e);Ie[t]=n}U.message=U.message||{};const Oe=[],De=[];var Ue=30,ke=80,Fe=0,Pe=!1;let Ye=null;function Be(t,e){const n=Ie[t];n?t=n(e):e&&(t=he(t,e)),He(),We(t)}function We(t){var e;const n=me(t=ce(t),ke);(null===(e=U.message)||void 0===e?void 0:e.reverseMultiLine)&&n.reverse(),n.forEach((t=>function(t){le(t)&&(Oe[Fe]=t,De[Fe]=!1,Fe=(Fe+1)%Ue)}(t))),Pe=!0}function He(){return!!Ye&&(We(Ye+"."),Ye=null,!0)}var Xe,Ge={__proto__:null,templates:Ie,install:Le,installAll:function(t){Object.entries(t).forEach((([t,e])=>Le(t,e)))},needsUpdate:function(t){return t&&(Pe=!0),Pe},configure:function(t){t||(t={}),Ue=t.length||30,ke=t.width||80;for(let t=0;t<Ue;++t)Oe[t]=null,De[t]=!1},add:Be,fromActor:function(t,e,n){(t.isPlayer()||t.isVisible())&&Be(e,n)},forPlayer:function(t,e,n){t.isPlayer()&&Be(e,n)},addCombat:function(t,e,n){if(t.isPlayer()||t.isVisible()){const t=Ie[e];t?e=t(n):n&&(e=he(e,n)),function(t){Ye?Ye+=", "+ce(t):Ye=t;Pe=!0}(e)}},confirmAll:function(){for(let t=0;t<De.length;t++)De[t]=!0;Pe=!0},forEach:function(t){He();for(let e=0;e<Ue;++e){const n=(Ue-e+Fe-1)%Ue,i=Oe[n];if(!i)return;if(!1===t(i,De[n],e))return}}};function Ke(t){t.flags&=~Xe.E_FIRED}!function(t){t[t.E_NEXT_ALWAYS=B(0)]="E_NEXT_ALWAYS",t[t.E_NEXT_EVERYWHERE=B(1)]="E_NEXT_EVERYWHERE",t[t.E_TREAT_AS_BLOCKING=B(3)]="E_TREAT_AS_BLOCKING",t[t.E_PERMIT_BLOCKING=B(4)]="E_PERMIT_BLOCKING",t[t.E_ABORT_IF_BLOCKS_MAP=B(5)]="E_ABORT_IF_BLOCKS_MAP",t[t.E_BLOCKED_BY_ITEMS=B(6)]="E_BLOCKED_BY_ITEMS",t[t.E_BLOCKED_BY_ACTORS=B(7)]="E_BLOCKED_BY_ACTORS",t[t.E_BLOCKED_BY_OTHER_LAYERS=B(8)]="E_BLOCKED_BY_OTHER_LAYERS",t[t.E_SUPERPRIORITY=B(9)]="E_SUPERPRIORITY",t[t.E_NO_MARK_FIRED=B(11)]="E_NO_MARK_FIRED",t[t.E_PROTECTED=B(12)]="E_PROTECTED",t[t.E_SPREAD_CIRCLE=B(13)]="E_SPREAD_CIRCLE",t[t.E_SPREAD_LINE=B(14)]="E_SPREAD_LINE",t[t.E_EVACUATE_CREATURES=B(18)]="E_EVACUATE_CREATURES",t[t.E_EVACUATE_ITEMS=B(19)]="E_EVACUATE_ITEMS",t[t.E_BUILD_IN_WALLS=B(20)]="E_BUILD_IN_WALLS",t[t.E_MUST_TOUCH_WALLS=B(21)]="E_MUST_TOUCH_WALLS",t[t.E_NO_TOUCH_WALLS=B(22)]="E_NO_TOUCH_WALLS",t[t.E_FIRED=B(23)]="E_FIRED",t[t.E_CLEAR_GROUND=B(17)]="E_CLEAR_GROUND",t[t.E_CLEAR_SURFACE=B(24)]="E_CLEAR_SURFACE",t[t.E_CLEAR_LIQUID=B(25)]="E_CLEAR_LIQUID",t[t.E_CLEAR_GAS=B(26)]="E_CLEAR_GAS",t[t.E_CLEAR_CELL=t.E_CLEAR_GROUND|t.E_CLEAR_SURFACE|t.E_CLEAR_LIQUID|t.E_CLEAR_GAS]="E_CLEAR_CELL",t[t.E_ONLY_IF_EMPTY=t.E_BLOCKED_BY_ITEMS|t.E_BLOCKED_BY_ACTORS]="E_ONLY_IF_EMPTY",t[t.E_ACTIVATE_DORMANT_MONSTER=B(27)]="E_ACTIVATE_DORMANT_MONSTER",t[t.E_AGGRAVATES_MONSTERS=B(28)]="E_AGGRAVATES_MONSTERS",t[t.E_RESURRECT_ALLY=B(29)]="E_RESURRECT_ALLY",t[t.E_EMIT_EVENT=B(30)]="E_EMIT_EVENT"}(Xe||(Xe={}));const je={};function Ve(t){var e;if(!t)throw new Error("opts required to make effect.");if("string"==typeof t)throw new Error("Cannot make effect from string: "+t);"function"==typeof t&&(t={fn:t});const n={flags:W(Xe,t.flags),chance:null!==(e=t.chance)&&void 0!==e?e:0,next:null,id:t.id||"n/a"};return t.next&&("string"==typeof t.next?n.next=t.next:n.next=Ve(t.next)),Object.values($e).forEach((e=>e.make(t,n))),n}function ze(t){if(!t)throw new Error("Cannot make effect from null | undefined");if("string"==typeof t){const e=je[t];if(e)return e;throw new Error("Unknown effect - "+t)}return Ve(t)}function qe(t,e){const n=Ve(e);return je[t]=n,n.id=t,n}const $e={};function Ze(t,e){$e[t]=e}Ze("fn",new class{make(t,e){if(!t.fn)return!0;if("function"!=typeof t.fn)throw new Error("fn effects must be functions.");return e.fn=t.fn,!0}async fire(t,e,n,i,r){return!!t.fn&&await t.fn(t,e,n,i,r)}});Ze("emit",new class{make(t,e){if(!t.emit)return!0;if("string"!=typeof t.emit)throw new Error('emit effects must be string name to emit: { emit: "EVENT" }');return e.emit=t.emit,!0}async fire(t,e,n,i,r){return!!t.emit&&await Dt(t.emit,n,i,r)}});Ze("message",new class{make(t,e){if(!t.message)return!0;if("string"!=typeof t.message)throw new Error("Emit must be configured with name of event to emit");return e.message=t.message,!0}async fire(t,e,n,i,r){if(!t.message)return!1;const s=!!(t.flags&Xe.E_FIRED);return r.actor=r.actor||(null==e?void 0:e.actorAt(n,i)),r.item=r.item||(null==e?void 0:e.itemAt(n,i)),!(!t.message||!t.message.length||s||!e.isVisible(n,i))&&(Be(t.message,r),!0)}});var Qe={__proto__:null,get Flags(){return Xe},fire:async function t(e,n,i,r,s={}){if(!e)return!1;if("string"==typeof e){const t=e;if(!(e=ze(t)))throw new Error("Failed to find effect: "+t)}const o=s;if(!o.force&&e.chance&&!L.chance(e.chance,1e4))return!1;const h=o.grid=q(n.width,n.height);let u=!0;const a=Object.values($e);for(let t of a)await t.fire(e,n,i,r,o)&&(u=!0);if(!u||!n.isVisible(i,r)||e.flags&Xe.E_NO_MARK_FIRED||(e.flags|=Xe.E_FIRED),e.next&&(u||e.flags&Xe.E_NEXT_ALWAYS)&&!D.gameHasEnded){const s="string"==typeof e.next?ze(e.next):e.next;e.flags&Xe.E_NEXT_EVERYWHERE?await h.forEachAsync((async(e,i,r)=>{e&&await t(s,n,i,r,o)})):await t(s,n,i,r,o)}return $(h),u},reset:Ke,resetAll:function(){Object.values(je).forEach((t=>Ke(t)))},effects:je,make:Ve,from:ze,install:qe,installAll:function(t){Object.entries(t).forEach((([t,e])=>{qe(t,e)}))},effectTypes:$e,installType:Ze};class Je{constructor(t={}){this.options={rounds:5,minWidth:10,minHeight:10,maxWidth:40,maxHeight:20,percentSeeded:50,birthParameters:"ffffffttt",survivalParameters:"ffffttttt"},Object.assign(this.options,t),this.options.birthParameters=this.options.birthParameters.toLowerCase(),this.options.survivalParameters=this.options.survivalParameters.toLowerCase(),this.options.minWidth>=this.options.maxWidth&&(this.options.minWidth=Math.round(.75*this.options.maxWidth),this.options.maxWidth=Math.round(1.25*this.options.maxWidth)),this.options.minHeight>=this.options.maxHeight&&(this.options.minHeight=Math.round(.75*this.options.maxHeight),this.options.maxHeight=Math.round(1.25*this.options.maxHeight))}carve(t,e,n){let i,r,s,o,h,u,a,l=new c(0,0,0,0);const f=q(t,e),d=Math.floor((f.width-this.options.maxWidth)/2),g=Math.floor((f.height-this.options.maxHeight)/2);let _=10;do{for(f.fill(0),i=0;i<this.options.maxWidth;i++)for(r=0;r<this.options.maxHeight;r++)f[i+d][r+g]=L.chance(this.options.percentSeeded)?1:0;for(s=0;s<this.options.rounds;s++)this._cellularAutomataRound(f)||(s=this.options.rounds);for(a=0,u=0,o=2,i=0;i<f.width;i++)for(r=0;r<f.height;r++)1==f[i][r]&&(h=f.floodFill(i,r,1,o),h>a&&(a=h,u=o),o++);f.valueBounds(u,l)}while((l.width<this.options.minWidth||l.height<this.options.minHeight||0==u)&&--_);for(i=0;i<f.width;i++)for(r=0;r<f.height;r++)f[i][r]==u&&n(i,r);return $(f),l}_cellularAutomataRound(t){let e,n,i,s,o,h,u;u=q(t.width,t.height),u.copy(t);let a=!1;for(e=0;e<t.width;e++)for(n=0;n<t.height;n++){for(i=0,h=0;h<r.length;h++)s=e+r[h][0],o=n+r[h][1],t.hasXY(s,o)&&u[s][o]&&i++;u[e][n]||"t"!=this.options.birthParameters[i]?u[e][n]&&"t"==this.options.survivalParameters[i]||(t[e][n]=0,a=!0):(t[e][n]=1,a=!0)}return $(u),a}}var tn={__proto__:null,Blob:Je,fillBlob:function(t,e={}){return new Je(e).carve(t.width,t.height,((e,n)=>t[e][n]=1))},make:function(t={}){return new Je(t)}};t.Random=I,t.blob=tn,t.canvas=Se,t.color=ne,t.colors=Ht,t.config=U,t.cosmetic=O,t.data=D,t.effect=Qe,t.events=Ut,t.flag=H,t.flags={},t.fov=yt,t.frequency=kt,t.grid=Q,t.io=Et,t.loop=mt,t.make=k,t.message=Ge,t.path=Ct,t.random=L,t.range=Y,t.scheduler=Ft,t.sprite=Ne,t.sprites=Ce,t.text=Ee,t.types={__proto__:null},t.utils=M,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-utils.min.js.map
